# Estructura EstÃ¡ndar - MD Research Web (Angular)

## ğŸ“‹ Tabla de Contenido
1. [ğŸš¨ Reglas Obligatorias](#-reglas-obligatorias)
2. [VisiÃ³n General](#visiÃ³n-general)
3. [Arquitectura de Capas](#arquitectura-de-capas)
4. [Estructura del Proyecto](#estructura-del-proyecto)
5. [Convenciones de CÃ³digo](#convenciones-de-cÃ³digo)
6. [Flujo de Datos](#flujo-de-datos)
7. [Ejemplos Completos](#ejemplos-completos)

---

## ğŸš¨ Reglas Obligatorias

Estas reglas deben aplicarse **INMEDIATAMENTE** en todo cÃ³digo nuevo y deben ir corrigiÃ©ndose paulatinamente en el cÃ³digo existente.

### ğŸ“ 1. LÃ­mites de TamaÃ±o de Componentes

**REGLA**: Los componentes NO deben exceder los siguientes lÃ­mites:

- âœ… **Component TypeScript**: MÃ¡ximo **500 lÃ­neas**
- âœ… **Template HTML**: MÃ¡ximo **300 lÃ­neas**
- âœ… **Estilos CSS/SCSS**: MÃ¡ximo **200 lÃ­neas**

**RazÃ³n**: Components grandes son difÃ­ciles de mantener, testear y entender.

**SoluciÃ³n**: Si un component excede estos lÃ­mites:
1. Dividir en sub-components mÃ¡s pequeÃ±os
2. Extraer lÃ³gica a services
3. Crear components reutilizables
4. Usar composition en lugar de herencia

**Ejemplo de RefactorizaciÃ³n**:

```typescript
// âŒ MAL - Component de 2000 lÃ­neas
@Component({
  selector: 'app-encuesta-form',
  // ... todo el cÃ³digo aquÃ­
})
export class EncuestaFormComponent {
  // 2000 lÃ­neas de cÃ³digo
}

// âœ… BIEN - Dividido en sub-components
@Component({
  selector: 'app-encuesta-form',
  imports: [
    EncuestaHeaderComponent,
    EncuestaDatosComponent,
    EncuestaDireccionComponent,
    EncuestaFabricantesComponent,
    EncuestaFooterComponent,
  ]
})
export class EncuestaFormComponent {
  // Solo lÃ³gica de coordinaciÃ³n (~200 lÃ­neas)
}
```

### ğŸš« 2. ProhibiciÃ³n de Archivos de DocumentaciÃ³n en Components

**REGLA**: NO incluir archivos de documentaciÃ³n dentro de carpetas de components.

**Archivos prohibidos**:
- âŒ `README.md` dentro de carpetas de components
- âŒ `INSTRUCCIONES.md` dentro de carpetas de components
- âŒ `CORRECCIONES.md` dentro de carpetas de components
- âŒ `TODO.md` dentro de carpetas de components
- âŒ Archivos `.txt` de cÃ³digo temporal

**UbicaciÃ³n correcta**:
- âœ… DocumentaciÃ³n general: `/docs/` en la raÃ­z del proyecto
- âœ… DocumentaciÃ³n de API: `/docs/api/`
- âœ… DocumentaciÃ³n de features: `/docs/features/`

**RazÃ³n**: Los archivos de documentaciÃ³n ensucian la estructura del proyecto y deben estar centralizados.

**AcciÃ³n inmediata**:
```bash
# Mover documentaciÃ³n a carpeta centralizada
mkdir -p docs/features
mv src/app/encuestas/encuesta-obras-form/*.md docs/features/
mv src/app/encuestas/encuesta-obras-form/*.txt docs/features/
```

### ğŸ’‰ 3. Uso Obligatorio de inject()

**REGLA**: SIEMPRE usar `inject()` en lugar de constructor injection.

```typescript
// âŒ MAL - Constructor injection (estilo antiguo)
export class RecursosComponent {
  constructor(
    private recursosService: RecursosService,
    private router: Router,
    private authService: AuthService
  ) {}
}

// âœ… BIEN - Function injection (moderno)
export class RecursosComponent {
  private recursosService = inject(RecursosService);
  private router = inject(Router);
  private authService = inject(AuthService);
}

// âœ… TAMBIÃ‰N BIEN - Usando private
export class RecursosComponent {
  private recursosService = inject(RecursosService);
  private router = inject(Router);
  
  // O sin private si es pÃºblico
  authService = inject(AuthService);
}
```

**RazÃ³n**: 
- MÃ¡s limpio y conciso
- Mejor para composition
- Facilita testing
- Es el estÃ¡ndar de Angular 14+

**ExcepciÃ³n**: Mantener constructor injection SOLO si:
- Necesitas lÃ³gica en el constructor antes de inyecciones
- EstÃ¡s usando herencia (muy raro en Angular moderno)

### ğŸ“Š 4. Uso de Computed Signals

**REGLA**: Usar `computed()` para valores derivados/calculados en lugar de mÃ©todos en el template.

```typescript
// âŒ MAL - MÃ©todo llamado en el template (se ejecuta en cada cambio)
export class RecursosComponent {
  recursos = signal<Recurso[]>([]);
  filtroNombre = '';

  // Se ejecuta muchas veces innecesariamente
  getRecursosFiltrados(): Recurso[] {
    return this.recursos().filter(r => 
      r.nombre.includes(this.filtroNombre)
    );
  }
}
// Template: <div *ngFor="let r of getRecursosFiltrados()">

// âœ… BIEN - Computed signal (se ejecuta solo cuando cambian dependencias)
export class RecursosComponent {
  recursos = signal<Recurso[]>([]);
  filtroNombre = signal('');

  // Solo se recalcula cuando recursos o filtroNombre cambian
  recursosFiltrados = computed(() => {
    const nombre = this.filtroNombre().toLowerCase();
    return this.recursos().filter(r => 
      r.nombre.toLowerCase().includes(nombre)
    );
  });
}
// Template: <div *ngFor="let r of recursosFiltrados()">
```

**RazÃ³n**:
- Mejor rendimiento (memoizaciÃ³n automÃ¡tica)
- Reactividad clara
- Menos re-renderizados

**Aplicar en**:
- Filtros de listas
- CÃ¡lculos derivados
- Transformaciones de datos
- Validaciones complejas

### ğŸ›¡ï¸ 5. Guards Obligatorios para Rutas Protegidas

**REGLA**: TODAS las rutas que requieren autenticaciÃ³n DEBEN tener un AuthGuard.

```typescript
// âŒ MAL - Rutas sin protecciÃ³n
export const routes: Routes = [
  {
    path: 'encuestas',
    loadComponent: () => import('./encuestas/encuestas-list.component')
      .then(m => m.EncuestasListComponent)
  }
];

// âœ… BIEN - Rutas protegidas con guard
export const routes: Routes = [
  {
    path: 'encuestas',
    canActivate: [authGuard],  // Guard funcional
    loadComponent: () => import('./encuestas/encuestas-list.component')
      .then(m => m.EncuestasListComponent)
  }
];
```

**Crear AuthGuard**:

### ğŸ§± 6. ReutilizaciÃ³n Obligatoria de Layout (Sidebar / UserMenu / PageHeader)

**REGLA**: Los mÃ³dulos deben **reutilizar componentes compartidos** para evitar estilos y HTML duplicados.

**Componentes obligatorios**:
- âœ… `app-sidebar` para el menÃº lateral
- âœ… `app-user-menu` para el menÃº de usuario
- âœ… `app-page-header` para el tÃ­tulo y acciones del header

**Formato obligatorio del tÃ­tulo**:
- âœ… `GestiÃ³n de X` (Title Case, sin MAYÃšSCULAS completas)

**Ejemplo correcto**:
```html
<div class="layout-container">
  <app-sidebar />
  <main class="main-content">
    <app-page-header title="GestiÃ³n de Empresas" subtitle="Texto opcional">
      <button class="btn-primary">AcciÃ³n</button>
      <app-user-menu />
    </app-page-header>
  </main>
</div>
```

**Prohibido**:
- âŒ Duplicar el HTML del sidebar en cada mÃ³dulo
- âŒ Estilos distintos por mÃ³dulo para sidebar o header
- âŒ Usar tÃ­tulos en MAYÃšSCULAS completas

```typescript
// src/app/core/guards/auth.guard.ts

import { inject } from '@angular/core';
import { Router } from '@angular/router';
import { CanActivateFn } from '@angular/router';
import { AuthService } from '../services/auth.service';

/**
 * Guard funcional para proteger rutas que requieren autenticaciÃ³n
 */
export const authGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);

  if (authService.isAuthenticated()) {
    return true;
  }

  // Redirigir a login guardando la URL de retorno
  router.navigate(['/inicio-sesion'], {
    queryParams: { returnUrl: state.url }
  });
  return false;
};
```

**RazÃ³n**:
- Seguridad en el frontend
- Mejor UX (evita cargas innecesarias)
- RedirecciÃ³n automÃ¡tica a login

### ğŸš¨ 6. Error Interceptor Obligatorio

**REGLA**: DEBE existir un interceptor global para manejo de errores HTTP.

```typescript
// src/app/core/interceptors/error.interceptor.ts

import { HttpInterceptorFn } from '@angular/common/http';
import { inject } from '@angular/core';
import { Router } from '@angular/router';
import { catchError, throwError } from 'rxjs';

/**
 * Interceptor para manejar errores HTTP globalmente
 * OBLIGATORIO en toda aplicaciÃ³n
 */
export const errorInterceptor: HttpInterceptorFn = (req, next) => {
  const router = inject(Router);

  return next(req).pipe(
    catchError((error) => {
      console.error('HTTP Error:', error);

      // Error de autenticaciÃ³n (401)
      if (error.status === 401) {
        // Limpiar token
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_data');
        // Redirigir a login
        router.navigate(['/inicio-sesion']);
      }

      // Error de permisos (403)
      if (error.status === 403) {
        console.error('Acceso denegado');
        // PodrÃ­a mostrar un toast/notification
      }

      // Error del servidor (500+)
      if (error.status >= 500) {
        console.error('Error del servidor:', error);
        // PodrÃ­a mostrar un toast/notification global
      }

      // Error de conexiÃ³n (0)
      if (error.status === 0) {
        console.error('Sin conexiÃ³n al servidor');
        // PodrÃ­a mostrar un toast/notification
      }

      return throwError(() => error);
    })
  );
};
```

**Registrar en app.config.ts**:

```typescript
export const appConfig: ApplicationConfig = {
  providers: [
    provideHttpClient(
      withFetch(),
      withInterceptors([
        authInterceptor,
        errorInterceptor,  // âœ… OBLIGATORIO
      ])
    ),
  ],
};
```

**RazÃ³n**:
- Manejo consistente de errores
- Evita cÃ³digo duplicado en cada component
- Mejor UX con mensajes de error claros
- Logout automÃ¡tico en 401

### ğŸ“ 7. DocumentaciÃ³n JSDoc Obligatoria

**REGLA**: Todos los mÃ©todos pÃºblicos de services y components DEBEN tener documentaciÃ³n JSDoc.

```typescript
// âŒ MAL - Sin documentaciÃ³n
export class RecursosService {
  listar(pagina: number, limite: number) {
    return this.http.get(`${this.apiUrl}`, { params: { pagina, limite } });
  }
}

// âœ… BIEN - Con documentaciÃ³n JSDoc
export class RecursosService {
  /**
   * Lista recursos con paginaciÃ³n
   * @param pagina NÃºmero de pÃ¡gina (1-based)
   * @param limite Cantidad de items por pÃ¡gina
   * @returns Observable con respuesta paginada de recursos
   * @example
   * this.recursosService.listar(1, 10).subscribe(recursos => {
   *   console.log(recursos.data);
   * });
   */
  listar(pagina: number, limite: number): Observable<PaginacionRespuesta<Recurso>> {
    let params = new HttpParams()
      .set('pagina', pagina.toString())
      .set('limite', limite.toString());
    
    return this.http.get<PaginacionRespuesta<Recurso>>(this.apiUrl, { params });
  }
}
```

**MÃ­nimo requerido en JSDoc**:
- DescripciÃ³n breve del mÃ©todo
- `@param` para cada parÃ¡metro
- `@returns` para el valor de retorno
- `@throws` si lanza excepciones (opcional pero recomendado)
- `@example` para mÃ©todos complejos (opcional)

### ğŸ¯ 8. SeÃ±ales Reactivas para Estado de UI

**REGLA**: TODO estado de UI debe manejarse con signals, NO con variables normales.

```typescript
// âŒ MAL - Variables normales (requiere detectChanges manual)
export class RecursosComponent {
  cargando = false;
  mostrarModal = false;
  recursos: Recurso[] = [];
}

// âœ… BIEN - Signals (reactividad automÃ¡tica)
export class RecursosComponent {
  cargando = signal(false);
  mostrarModal = signal(false);
  recursos = signal<Recurso[]>([]);
}
```

**Estado de UI incluye**:
- Flags de loading/cargando
- Modales/drawers abiertos o cerrados
- Datos mostrados en pantalla
- PaginaciÃ³n (pÃ¡gina actual, total)
- Filtros aplicados (si son reactivos)

**ExcepciÃ³n**: Variables de formulario con `[(ngModel)]` pueden ser normales:
```typescript
// âœ… OK - Para ngModel bidireccional
filtroNombre = '';
filtroCategoria = '';

// Pero si necesitas reactividad, usa signals:
filtroNombre = signal('');
filtroCategoria = signal('');
```

### ğŸ§ª 9. ValidaciÃ³n Antes de EnvÃ­o

**REGLA**: SIEMPRE validar datos en el component antes de llamar al service.

```typescript
// âŒ MAL - Sin validaciÃ³n
guardar(): void {
  this.recursosService.crear(this.recurso).subscribe({
    next: () => this.router.navigate(['/recursos']),
    error: (error) => console.error(error)
  });
}

// âœ… BIEN - Con validaciÃ³n
guardar(): void {
  // 1. Validar formulario
  if (!this.validarFormulario()) {
    return;
  }

  // 2. Mostrar estado de carga
  this.guardando.set(true);

  // 3. Llamar al service
  this.recursosService.crear(this.recurso).subscribe({
    next: () => {
      this.guardando.set(false);
      this.router.navigate(['/recursos']);
    },
    error: (error) => {
      console.error('Error al guardar:', error);
      this.guardando.set(false);
      this.manejarError(error);
    }
  });
}

private validarFormulario(): boolean {
  // Resetear errores
  this.errores = { nombre: '', categoria: '' };
  
  let valido = true;

  // Validar cada campo
  if (!this.recurso.nombre?.trim()) {
    this.errores.nombre = 'El nombre es requerido';
    valido = false;
  }

  if (!this.recurso.categoria) {
    this.errores.categoria = 'La categorÃ­a es requerida';
    valido = false;
  }

  return valido;
}
```

**Validaciones mÃ­nimas**:
- Campos requeridos no vacÃ­os
- Formatos correctos (email, telÃ©fono, etc.)
- Rangos vÃ¡lidos (nÃºmeros, fechas)
- Longitudes mÃ­nimas/mÃ¡ximas

### ğŸ¨ 10. Imports Organizados

**REGLA**: Los imports deben estar organizados en grupos especÃ­ficos.

```typescript
// âœ… BIEN - Imports organizados
// 1. Angular Core
import { Component, signal, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

// 2. Angular Router
import { Router, ActivatedRoute } from '@angular/router';

// 3. Services propios
import { RecursosService } from '../../core/services/recursos.service';
import { AuthService } from '../../core/services/auth.service';

// 4. Models e Interfaces
import { Recurso, PaginacionRespuesta } from '../../core/models';

// 5. Constants
import { ROLES } from '../../core/constants';

// 6. Components hijos (si aplica)
import { RecursoItemComponent } from './recurso-item/recurso-item.component';

@Component({
  selector: 'app-recursos-list',
  standalone: true,
  imports: [CommonModule, FormsModule, RecursoItemComponent],
  templateUrl: './recursos-list.component.html',
  styleUrl: './recursos-list.component.css'
})
export class RecursosListComponent {}
```

**Orden de imports**:
1. Angular Core y mÃ³dulos
2. Angular Router
3. RxJS (si se usa)
4. Services propios
5. Models, interfaces, tipos
6. Constants
7. Components hijos

### ğŸ”’ 11. No Exponer LÃ³gica Sensible en el Frontend

**REGLA**: NUNCA incluir lÃ³gica de negocio sensible, validaciones crÃ­ticas o secretos en el frontend.

```typescript
// âŒ MAL - ValidaciÃ³n de permisos en el frontend (inseguro)
export class RecursosComponent {
  eliminarRecurso(id: number): void {
    // âŒ NO hacer validaciones de permisos aquÃ­
    if (this.authService.getRol() !== 'Administrador') {
      alert('No tienes permisos');
      return;
    }
    this.recursosService.eliminar(id).subscribe();
  }
}

// âœ… BIEN - Solo UI, validaciÃ³n en el backend
export class RecursosComponent {
  eliminarRecurso(id: number): void {
    if (!confirm('Â¿Eliminar recurso?')) {
      return;
    }
    
    // El backend valida permisos
    this.recursosService.eliminar(id).subscribe({
      next: () => this.cargarRecursos(),
      error: (error) => {
        // El backend retorna 403 si no tiene permisos
        if (error.status === 403) {
          alert('No tienes permisos para eliminar');
        }
      }
    });
  }
}
```

**Nunca incluir en el frontend**:
- âŒ API Keys o secretos
- âŒ LÃ³gica de cÃ¡lculo de precios
- âŒ Validaciones de permisos crÃ­ticas
- âŒ Algoritmos de negocio importantes
- âŒ Credenciales o tokens hardcodeados

**El frontend solo**:
- âœ… Valida formato y datos bÃ¡sicos (UX)
- âœ… Muestra/oculta elementos segÃºn rol (UI)
- âœ… ConfÃ­a en las respuestas del backend

### ğŸ“± 12. Responsive Design Obligatorio

**REGLA**: TODAS las vistas deben ser responsive y funcionar en mÃ³viles.

```scss
// âœ… BIEN - Mobile-first approach

// Estilos base para mÃ³vil
.recursos-list {
  padding: 1rem;
  
  .recurso-item {
    margin-bottom: 1rem;
    padding: 0.5rem;
  }
}

// Tablets
@media (min-width: 768px) {
  .recursos-list {
    padding: 2rem;
    
    .recurso-item {
      padding: 1rem;
    }
  }
}

// Desktop
@media (min-width: 1024px) {
  .recursos-list {
    max-width: 1200px;
    margin: 0 auto;
  }
}
```

**Breakpoints estÃ¡ndar**:
- Mobile: `< 768px` (base)
- Tablet: `>= 768px`
- Desktop: `>= 1024px`
- Large Desktop: `>= 1440px`

### ğŸ¨ 13. Sistema de Design Tokens Obligatorio

**REGLA**: TODOS los estilos deben usar un sistema de Design Tokens basado en variables SCSS. NUNCA usar estilos inline ni valores hardcodeados.

**Problema**: Angular encapsula estilos por component, causando que debas usar estilos inline (mala prÃ¡ctica).

**SoluciÃ³n Obligatoria**: Implementar sistema de Design Tokens con SB Admin 2.

#### Estructura Requerida:

```
src/
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ _variables.scss    # âœ… OBLIGATORIO - Variables de diseÃ±o
â”‚   â”œâ”€â”€ _mixins.scss       # âœ… OBLIGATORIO - Mixins reutilizables
â”‚   â””â”€â”€ _utilities.scss    # âœ… OPCIONAL - Clases de utilidad
â””â”€â”€ styles.scss            # Importa todo
```

#### Variables MÃ­nimas Requeridas:

```scss
// src/styles/_variables.scss

// Colores (basados en SB Admin 2)
$primary: #4e73df;
$primary-dark: #224abe;
$success: #1cc88a;
$danger: #e74a3b;
$warning: #f6c23e;

// Grays
$gray-100: #f8f9fc;
$gray-400: #d1d3e2;
$gray-600: #858796;
$gray-800: #5a5c69;

// TipografÃ­a
$font-family-primary: 'Nunito', sans-serif;
$font-size-sm: 0.875rem;
$font-size-base: 1rem;

// Espaciado
$spacing-sm: 0.5rem;
$spacing-md: 1rem;
$spacing-lg: 1.5rem;

// Otros
$border-radius: 0.35rem;
$shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
$transition-base: all 0.15s ease-in-out;
```

#### Mixins Obligatorios:

```scss
// src/styles/_mixins.scss
@import 'variables';

// BotÃ³n primario
@mixin button-primary {
  padding: $spacing-sm $spacing-md;
  background-color: $primary;
  color: white;
  border: none;
  border-radius: $border-radius;
  font-family: $font-family-primary;
  font-size: $font-size-sm;
  cursor: pointer;
  transition: $transition-base;
  
  &:hover:not(:disabled) {
    background-color: $primary-dark;
  }
  
  &:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }
}

// Card
@mixin card {
  background: white;
  border-radius: $border-radius;
  box-shadow: $shadow;
  border: 1px solid $gray-400;
}

// Form control
@mixin form-control {
  padding: $spacing-sm $spacing-md;
  border: 1px solid $gray-400;
  border-radius: $border-radius;
  font-family: $font-family-primary;
  font-size: $font-size-sm;
  
  &:focus {
    border-color: $primary;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba($primary, 0.25);
  }
}
```

#### Uso en Components:

```scss
// component.scss
@import '../../styles/variables';
@import '../../styles/mixins';

// âœ… BIEN - Usar variables y mixins
.mi-boton {
  @include button-primary;
}

.mi-input {
  @include form-control;
  width: 100%;
}

.mi-card {
  @include card;
  padding: $spacing-lg;
}

// âœ… BIEN - Usar variables directamente
.mi-titulo {
  color: $gray-800;
  font-size: $font-size-lg;
  margin-bottom: $spacing-md;
}
```

#### Clases Globales en styles.scss:

```scss
// src/styles.scss
@import 'styles/variables';
@import 'styles/mixins';

// Clases globales reutilizables
.btn-primary {
  @include button-primary;
}

.card {
  @include card;
}

.form-control {
  @include form-control;
}

// Utilidades
.d-flex { display: flex !important; }
.gap-2 { gap: $spacing-sm !important; }
.mb-3 { margin-bottom: $spacing-md !important; }
.text-center { text-align: center !important; }
```

#### ğŸš« Prohibido:

```html
<!-- âŒ NUNCA HACER - Estilos inline -->
<button style="background-color: #4e73df; color: white;">
  Guardar
</button>

<!-- âŒ NUNCA HACER - Valores hardcodeados en CSS -->
```

```scss
/* âŒ MAL */
.boton {
  background-color: #4e73df;  /* Valor hardcodeado */
  padding: 8px 16px;           /* Valores hardcodeados */
}
```

#### âœ… Obligatorio:

```html
<!-- âœ… Usar clases globales -->
<button class="btn-primary">Guardar</button>

<!-- âœ… Usar clases del component -->
<button class="mi-boton-custom">Guardar</button>
```

```scss
/* âœ… BIEN - Usar variables */
.mi-boton-custom {
  @include button-primary;
  // Personalizaciones si son necesarias
  font-weight: $font-weight-bold;
}

/* âœ… BIEN - Variables directamente */
.mi-container {
  padding: $spacing-lg;
  background-color: $gray-100;
  border-radius: $border-radius;
}
```

#### Razones:

1. **Mantenibilidad**: Cambiar colores en un solo lugar
2. **Consistencia**: Todos los components usan los mismos valores
3. **Escalabilidad**: FÃ¡cil agregar themes o modo oscuro
4. **Legibilidad**: `$primary` es mÃ¡s claro que `#4e73df`
5. **Sin estilos inline**: View Encapsulation resuelto correctamente

#### AcciÃ³n Inmediata:

1. âœ… Crear carpeta `src/styles/`
2. âœ… Crear archivos `_variables.scss` y `_mixins.scss`
3. âœ… Importar en `styles.scss`
4. âœ… Usar en todos los components nuevos
5. ğŸ”„ Migrar paulatinamente estilos inline existentes

---

## ğŸ¨ GestiÃ³n de Estilos (SB Admin 2 + Angular)

### Problema: View Encapsulation en Angular

Angular encapsula los estilos de cada componente por defecto, lo que significa que:

1. **Estilos en `component.css` NO afectan a otros components**
2. **Estilos globales (en `styles.scss`) SÃ afectan a todos**
3. **Clases de Bootstrap/SB Admin 2 no funcionan si no estÃ¡n cargadas globalmente**

Este es el motivo por el cual **tenÃ­as que escribir estilos inline** en las etiquetas.

### âŒ Problema ComÃºn

```typescript
// component.ts
@Component({
  selector: 'app-recursos',
  templateUrl: './recursos.component.html',
  styleUrl: './recursos.component.css',  // âŒ Estilos encapsulados
})
export class RecursosComponent {}
```

```css
/* recursos.component.css */
/* âŒ Estos estilos NO funcionan si intentas usar clases de SB Admin 2 */
.btn-primary {
  background-color: #4e73df;
}
```

```html
<!-- Template -->
<!-- âŒ La clase btn-primary no funciona porque estÃ¡ encapsulada -->
<button class="btn-primary">Guardar</button>

<!-- âŒ MALA PRÃCTICA - Estilo inline (lo que estabas haciendo) -->
<button style="background-color: #4e73df; color: white; padding: 0.5rem 1rem;">
  Guardar
</button>
```

### âœ… SoluciÃ³n 1: Sistema de Design Tokens (RECOMENDADO)

Crear un sistema de tokens de diseÃ±o basado en SB Admin 2.

#### Paso 1: Crear archivo de variables SCSS

```scss
// src/styles/_variables.scss

// ==============================================
// SB ADMIN 2 - DESIGN TOKENS
// ==============================================

// Colores Primarios
$primary: #4e73df;
$primary-dark: #224abe;
$primary-light: #6685e0;

// Colores de Estado
$success: #1cc88a;
$info: #36b9cc;
$warning: #f6c23e;
$danger: #e74a3b;

// Colores Neutros (Grays)
$gray-100: #f8f9fc;
$gray-200: #eaecf4;
$gray-300: #dddfeb;
$gray-400: #d1d3e2;
$gray-500: #b7b9cc;
$gray-600: #858796;
$gray-700: #6e707e;
$gray-800: #5a5c69;
$gray-900: #3a3b45;

// TipografÃ­a
$font-family-primary: 'Nunito', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
$font-family-heading: 'Nunito', 'Roboto', sans-serif;

$font-size-xs: 0.7rem;
$font-size-sm: 0.875rem;
$font-size-base: 1rem;
$font-size-lg: 1.25rem;
$font-size-xl: 1.75rem;

$font-weight-light: 300;
$font-weight-normal: 400;
$font-weight-bold: 700;
$font-weight-extrabold: 800;

// Espaciado
$spacing-xs: 0.25rem;
$spacing-sm: 0.5rem;
$spacing-md: 1rem;
$spacing-lg: 1.5rem;
$spacing-xl: 2rem;

// Border Radius
$border-radius-sm: 0.2rem;
$border-radius: 0.35rem;
$border-radius-lg: 0.5rem;
$border-radius-pill: 10rem;

// Shadows
$shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
$shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
$shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);

// Transitions
$transition-base: all 0.15s ease-in-out;
$transition-fast: all 0.1s ease-in-out;
$transition-slow: all 0.3s ease-in-out;
```

#### Paso 2: Crear mixins reutilizables

```scss
// src/styles/_mixins.scss

@import 'variables';

// Botones
@mixin button-base {
  padding: $spacing-sm $spacing-md;
  font-size: $font-size-sm;
  font-weight: $font-weight-normal;
  font-family: $font-family-primary;
  border: none;
  border-radius: $border-radius;
  cursor: pointer;
  transition: $transition-base;
  box-shadow: $shadow-sm;
  
  &:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }
}

@mixin button-primary {
  @include button-base;
  color: white;
  background-color: $primary;
  
  &:hover:not(:disabled) {
    background-color: $primary-dark;
    box-shadow: $shadow;
  }
}

@mixin button-success {
  @include button-base;
  color: white;
  background-color: $success;
  
  &:hover:not(:disabled) {
    background-color: darken($success, 10%);
    box-shadow: $shadow;
  }
}

// Cards
@mixin card {
  background: white;
  border-radius: $border-radius;
  box-shadow: $shadow;
  border: 1px solid $gray-300;
}

@mixin card-body {
  padding: $spacing-lg;
}

// Forms
@mixin form-control {
  padding: $spacing-sm $spacing-md;
  font-size: $font-size-sm;
  font-family: $font-family-primary;
  border: 1px solid $gray-400;
  border-radius: $border-radius;
  color: $gray-700;
  transition: border-color 0.15s ease-in-out;
  
  &:focus {
    border-color: $primary;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba($primary, 0.25);
  }
}

// Estados de badge
@mixin badge($color, $bg-color) {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: $border-radius-pill;
  font-size: $font-size-xs;
  font-weight: $font-weight-bold;
  font-family: $font-family-primary;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.05rem;
  color: $color;
  background-color: $bg-color;
}
```

#### Paso 3: Importar en styles.scss global

```scss
// src/styles.scss

// 1. Importar variables y mixins
@import 'styles/variables';
@import 'styles/mixins';

// 2. Reset bÃ¡sico
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

// 3. Estilos base del body
body {
  font-family: $font-family-primary;
  font-size: $font-size-base;
  line-height: 1.6;
  color: $gray-800;
  background-color: $gray-100;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

// 4. Headings
h1, h2, h3, h4, h5, h6 {
  font-family: $font-family-heading;
  font-weight: $font-weight-bold;
  line-height: 1.2;
  color: $gray-800;
  margin-bottom: $spacing-md;
}

// 5. Clases de utilidad globales (inspiradas en SB Admin 2)
.btn-primary {
  @include button-primary;
}

.btn-success {
  @include button-success;
}

.card {
  @include card;
}

.card-body {
  @include card-body;
}

.form-control {
  @include form-control;
}

// Estados de badge
.badge-success {
  @include badge(#155724, $success);
}

.badge-warning {
  @include badge(#856404, $warning);
}

.badge-danger {
  @include badge(white, $danger);
}

.badge-primary {
  @include badge(white, $primary);
}

// Transiciones de rutas
router-outlet ~ * {
  animation: fadeInRoute 0.4s ease-in;
}

@keyframes fadeInRoute {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

#### Paso 4: Usar en components

```typescript
// recursos.component.ts
@Component({
  selector: 'app-recursos',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './recursos.component.html',
  styleUrl: './recursos.component.scss',  // âœ… Ahora usa .scss
})
export class RecursosComponent {}
```

```scss
// recursos.component.scss
@import '../../styles/variables';
@import '../../styles/mixins';

// âœ… BIEN - Usar variables y mixins
.recursos-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: $spacing-xl;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: $spacing-xl;
  
  h1 {
    color: $gray-800;
    font-size: $font-size-xl;
  }
}

// Usar mixin para botÃ³n personalizado
.btn-nuevo {
  @include button-primary;
  // Personalizaciones adicionales si son necesarias
  padding: $spacing-md $spacing-lg;
}

.table-container {
  @include card;
  overflow-x: auto;
}

// Usar variables para consistencia
.filtro-input {
  @include form-control;
  width: 100%;
}
```

```html
<!-- recursos.component.html -->
<div class="recursos-container">
  <div class="header">
    <h1>Recursos</h1>
    <!-- âœ… Clase local que usa mixin -->
    <button class="btn-nuevo" (click)="nuevoRecurso()">
      Nuevo Recurso
    </button>
  </div>
  
  <div class="table-container">
    <!-- contenido -->
  </div>
</div>
```

### âœ… SoluciÃ³n 2: ViewEncapsulation.None (Usar con PRECAUCIÃ“N)

Si necesitas que los estilos de un component NO estÃ©n encapsulados:

```typescript
import { Component, ViewEncapsulation } from '@angular/core';

@Component({
  selector: 'app-recursos',
  templateUrl: './recursos.component.html',
  styleUrl: './recursos.component.css',
  encapsulation: ViewEncapsulation.None,  // âš ï¸ PRECAUCIÃ“N
})
export class RecursosComponent {}
```

**âš ï¸ ADVERTENCIA**: Usar `ViewEncapsulation.None`:
- Los estilos se filtran a TODA la aplicaciÃ³n
- Puede causar conflictos de estilos
- Dificulta el mantenimiento
- **SOLO usar en casos muy especÃ­ficos** (ej: wrappers de librerÃ­as externas)

### âœ… SoluciÃ³n 3: Clases de Utilidad Globales

Crear clases de utilidad en `styles.scss` que se puedan usar en cualquier component:

```scss
// src/styles.scss

// ... otras importaciones ...

// ==============================================
// UTILITY CLASSES (Inspiradas en SB Admin 2)
// ==============================================

// Spacing (padding y margin)
.p-0 { padding: 0 !important; }
.p-1 { padding: $spacing-xs !important; }
.p-2 { padding: $spacing-sm !important; }
.p-3 { padding: $spacing-md !important; }
.p-4 { padding: $spacing-lg !important; }
.p-5 { padding: $spacing-xl !important; }

.m-0 { margin: 0 !important; }
.m-1 { margin: $spacing-xs !important; }
.m-2 { margin: $spacing-sm !important; }
.m-3 { margin: $spacing-md !important; }
.m-4 { margin: $spacing-lg !important; }
.m-5 { margin: $spacing-xl !important; }

.mb-2 { margin-bottom: $spacing-sm !important; }
.mb-3 { margin-bottom: $spacing-md !important; }
.mb-4 { margin-bottom: $spacing-lg !important; }

.mt-2 { margin-top: $spacing-sm !important; }
.mt-3 { margin-top: $spacing-md !important; }
.mt-4 { margin-top: $spacing-lg !important; }

// Display
.d-flex { display: flex !important; }
.d-block { display: block !important; }
.d-none { display: none !important; }

// Flex utilities
.flex-column { flex-direction: column !important; }
.flex-row { flex-direction: row !important; }
.justify-content-between { justify-content: space-between !important; }
.justify-content-center { justify-content: center !important; }
.align-items-center { align-items: center !important; }
.gap-1 { gap: $spacing-xs !important; }
.gap-2 { gap: $spacing-sm !important; }
.gap-3 { gap: $spacing-md !important; }

// Text utilities
.text-center { text-align: center !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }

.text-primary { color: $primary !important; }
.text-success { color: $success !important; }
.text-danger { color: $danger !important; }
.text-warning { color: $warning !important; }
.text-muted { color: $gray-600 !important; }

.font-weight-bold { font-weight: $font-weight-bold !important; }
.font-weight-normal { font-weight: $font-weight-normal !important; }

// Width utilities
.w-100 { width: 100% !important; }
.w-50 { width: 50% !important; }
.w-auto { width: auto !important; }

// Shadow utilities
.shadow-sm { box-shadow: $shadow-sm !important; }
.shadow { box-shadow: $shadow !important; }
.shadow-lg { box-shadow: $shadow-lg !important; }
```

### ğŸ¨ Paleta de Colores SB Admin 2

```scss
// Colores base (ya definidos arriba)
$primary: #4e73df;      // Azul principal
$success: #1cc88a;      // Verde
$info: #36b9cc;         // Cyan
$warning: #f6c23e;      // Amarillo
$danger: #e74a3b;       // Rojo

// Grays
$gray-100: #f8f9fc;     // Fondo claro
$gray-200: #eaecf4;     // Hover
$gray-300: #dddfeb;     // Bordes claros
$gray-400: #d1d3e2;     // Bordes
$gray-500: #b7b9cc;     // Bordes oscuros
$gray-600: #858796;     // Texto secundario
$gray-700: #6e707e;     // Texto
$gray-800: #5a5c69;     // Texto principal
$gray-900: #3a3b45;     // Texto oscuro
```

### ğŸ“ Estructura de Archivos de Estilos

```
src/
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ _variables.scss       # Variables de diseÃ±o
â”‚   â”œâ”€â”€ _mixins.scss          # Mixins reutilizables
â”‚   â”œâ”€â”€ _utilities.scss       # Clases de utilidad
â”‚   â””â”€â”€ _components.scss      # Components globales
â”‚
â””â”€â”€ styles.scss               # Archivo principal que importa todo
```

### ğŸš« Anti-Patrones a Evitar

```html
<!-- âŒ NO HACER - Estilos inline -->
<button style="background-color: #4e73df; color: white; padding: 0.5rem 1rem;">
  Guardar
</button>

<!-- âŒ NO HACER - Clases hardcodeadas sin variables -->
<button class="btn-custom" style="background: #4e73df;">
  Guardar
</button>

<!-- âœ… HACER - Usar clases globales -->
<button class="btn-primary">
  Guardar
</button>

<!-- âœ… HACER - Usar clases locales con variables -->
<button class="btn-guardar">
  Guardar
</button>
```

```scss
// âŒ NO HACER - Colores hardcodeados
.btn-guardar {
  background-color: #4e73df;
  color: white;
}

// âœ… HACER - Usar variables
.btn-guardar {
  @include button-primary;
}

// âœ… TAMBIÃ‰N BIEN - Usar variables directamente
.btn-guardar {
  background-color: $primary;
  color: white;
  padding: $spacing-sm $spacing-md;
  border-radius: $border-radius;
}
```

### ğŸ“ Reglas de Estilos

**REGLA 1**: NUNCA usar estilos inline en templates
- âŒ `<div style="color: red">`
- âœ… `<div class="text-danger">`

**REGLA 2**: SIEMPRE usar variables SCSS en lugar de valores hardcodeados
- âŒ `background-color: #4e73df;`
- âœ… `background-color: $primary;`

**REGLA 3**: Crear mixins para patrones repetitivos
- âŒ Copiar y pegar estilos de botones en cada component
- âœ… Usar `@include button-primary;`

**REGLA 4**: Usar `::ng-deep` SOLO cuando sea absolutamente necesario
```scss
// âš ï¸ Usar con precauciÃ³n y SIEMPRE con selector padre
:host ::ng-deep .external-library-class {
  color: $primary;
}
```

**REGLA 5**: Mantener clases de utilidad en `styles.scss` global
- Clases como `.d-flex`, `.text-center`, `.btn-primary` van en global
- Estilos especÃ­ficos del component van en su `.scss`

### ğŸ¯ Ejemplo Completo

```typescript
// recursos.component.ts
@Component({
  selector: 'app-recursos',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './recursos.component.html',
  styleUrl: './recursos.component.scss',
})
export class RecursosComponent {
  recursos = signal<Recurso[]>([]);
  // ...
}
```

```scss
// recursos.component.scss
@import '../../styles/variables';
@import '../../styles/mixins';

.recursos-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: $spacing-xl;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: $spacing-xl;
  
  h1 {
    font-size: $font-size-xl;
    color: $gray-800;
    margin: 0;
  }
}

.btn-nuevo-recurso {
  @include button-primary;
  display: flex;
  align-items: center;
  gap: $spacing-sm;
}

.recursos-table {
  @include card;
  overflow-x: auto;
  
  table {
    width: 100%;
    font-size: $font-size-sm;
    border-collapse: collapse;
    
    th {
      background-color: $gray-100;
      color: $gray-700;
      font-weight: $font-weight-bold;
      text-transform: uppercase;
      font-size: $font-size-xs;
      padding: $spacing-md;
      border-bottom: 1px solid $gray-300;
    }
    
    td {
      padding: $spacing-md;
      color: $gray-800;
      border-bottom: 1px solid $gray-300;
    }
    
    tr:hover {
      background-color: $gray-100;
    }
  }
}
```

```html
<!-- recursos.component.html -->
<div class="recursos-page">
  <!-- Header -->
  <div class="page-header">
    <h1>GestiÃ³n de Recursos</h1>
    <button class="btn-nuevo-recurso" (click)="nuevoRecurso()">
      <svg width="16" height="16" viewBox="0 0 16 16">
        <path d="M8 0v16M0 8h16" stroke="currentColor" stroke-width="2"/>
      </svg>
      Nuevo Recurso
    </button>
  </div>

  <!-- Filtros usando clases globales -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex gap-3">
        <input type="text" class="form-control" placeholder="Buscar...">
        <button class="btn-primary">Buscar</button>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="recursos-table">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (recurso of recursos(); track recurso.id) {
          <tr>
            <td>{{ recurso.id }}</td>
            <td>{{ recurso.nombre }}</td>
            <td>
              <!-- Usar clases globales de badge -->
              <span class="badge-success">Activo</span>
            </td>
            <td class="d-flex gap-2 justify-content-center">
              <button class="btn-primary">Editar</button>
              <button class="btn-danger">Eliminar</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>
```

---

## ğŸ“‹ Resumen de Reglas CrÃ­ticas

| # | Regla | Prioridad | AcciÃ³n |
|---|-------|-----------|--------|
| 1 | LÃ­mite 500 lÃ­neas por component | ğŸ”´ Alta | Refactorizar components grandes |
| 2 | Sin archivos MD/TXT en components | ğŸ”´ Alta | Mover a /docs/ |
| 3 | Usar inject() siempre | ğŸŸ¡ Media | Migrar paulatinamente |
| 4 | Computed signals para derivados | ğŸŸ¡ Media | Aplicar en nuevo cÃ³digo |
| 5 | AuthGuard en rutas protegidas | ğŸ”´ Alta | Implementar YA |
| 6 | Error Interceptor global | ğŸ”´ Alta | Implementar YA |
| 7 | JSDoc en mÃ©todos pÃºblicos | ğŸŸ¢ Baja | Aplicar paulatinamente |
| 8 | Signals para estado UI | ğŸŸ¡ Media | Aplicar en nuevo cÃ³digo |
| 9 | ValidaciÃ³n antes de envÃ­o | ğŸ”´ Alta | Siempre en nuevo cÃ³digo |
| 10 | Imports organizados | ğŸŸ¢ Baja | Aplicar paulatinamente |
| 11 | Sin lÃ³gica sensible en frontend | ğŸ”´ Alta | Revisar cÃ³digo existente |
| 12 | Responsive design | ğŸŸ¡ Media | Probar en mÃ³vil siempre |
| 13 | Sistema de Design Tokens | ğŸ”´ Alta | Implementar YA |

### ğŸš€ Plan de AcciÃ³n Inmediata

**Hacer HOY**:
1. âœ… Crear `authGuard` y aplicar a todas las rutas protegidas
2. âœ… Crear `errorInterceptor` y registrar en `app.config.ts`
3. âœ… Mover archivos `.md` y `.txt` de carpetas de components a `/docs/`
4. âœ… Crear estructura de Design Tokens (`src/styles/`)
5. âœ… Crear `_variables.scss` con colores y espaciados de SB Admin 2
6. âœ… Crear `_mixins.scss` con componentes reutilizables

**Hacer esta SEMANA**:
1. ğŸ”„ Identificar components > 500 lÃ­neas y dividirlos
2. ğŸ”„ Migrar a `inject()` en nuevo cÃ³digo
3. ğŸ”„ Agregar validaciones en formularios sin validaciÃ³n
4. ğŸ”„ Migrar estilos inline a clases con Design Tokens

**Hacer este MES**:
1. ğŸ“ Agregar JSDoc a services principales
2. ğŸ“ Convertir mÃ©todos de filtrado a computed signals
3. ğŸ“ Revisar responsive en todas las vistas
4. ğŸ“ Eliminar todos los estilos inline del cÃ³digo

---

## ğŸ¯ VisiÃ³n General

Este proyecto es una aplicaciÃ³n Angular moderna que utiliza **Standalone Components** (sin mÃ³dulos NgModules) y las Ãºltimas caracterÃ­sticas de Angular 20+.

### Stack TecnolÃ³gico
- **Framework**: Angular 20.x (Standalone Components)
- **GestiÃ³n de Estado**: Signals (Angular 20)
- **DetecciÃ³n de Cambios**: Zoneless Change Detection
- **HTTP**: HttpClient con interceptores funcionales
- **Routing**: Lazy Loading con loadComponent
- **Estilos**: SCSS
- **Node**: 20.x

### CaracterÃ­sticas Clave
- âœ… **Sin NgModules** - Todo es standalone
- âœ… **Signals** - Manejo reactivo de estado
- âœ… **Zoneless** - Mejor rendimiento
- âœ… **Functional Interceptors** - Interceptores modernos
- âœ… **Lazy Loading** - Carga diferida de componentes

---

## ğŸ—ï¸ Arquitectura de Capas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE (Browser)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LAYER 1: COMPONENTS                     â”‚
â”‚  - PresentaciÃ³n y UI                                    â”‚
â”‚  - Manejo de eventos de usuario                        â”‚
â”‚  - Uso de Signals para estado local                    â”‚
â”‚  - ValidaciÃ³n bÃ¡sica de formularios                    â”‚
â”‚  - NO contiene lÃ³gica de negocio                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LAYER 2: SERVICES                      â”‚
â”‚  - ComunicaciÃ³n con API (HttpClient)                   â”‚
â”‚  - GestiÃ³n de estado global (si aplica)                â”‚
â”‚  - TransformaciÃ³n de datos                             â”‚
â”‚  - CachÃ© (si aplica)                                   â”‚
â”‚  - LÃ³gica de negocio compartida                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 3: INTERCEPTORS                       â”‚
â”‚  - AutenticaciÃ³n (agregar JWT token)                   â”‚
â”‚  - Manejo de errores global                            â”‚
â”‚  - Logging                                             â”‚
â”‚  - TransformaciÃ³n de requests/responses                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API REST (Backend)                      â”‚
â”‚  - NestJS API (md-research-api)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Estructura del Proyecto

### Estructura General

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ app.ts                           # Componente raÃ­z (standalone)
â”‚   â”œâ”€â”€ app.html                         # Template del componente raÃ­z
â”‚   â”œâ”€â”€ app.scss                         # Estilos del componente raÃ­z
â”‚   â”œâ”€â”€ app.routes.ts                    # ConfiguraciÃ³n de rutas
â”‚   â”œâ”€â”€ app.config.ts                    # ConfiguraciÃ³n de la aplicaciÃ³n
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                            # Elementos centrales de la app
â”‚   â”‚   â”œâ”€â”€ services/                    # Servicios globales
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ encuestas.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ ...otros-services.ts
â”‚   â”‚   â”œâ”€â”€ interceptors/                # Interceptores HTTP
â”‚   â”‚   â”‚   â””â”€â”€ auth.interceptor.ts
â”‚   â”‚   â”œâ”€â”€ guards/                      # Guards de navegaciÃ³n (opcional)
â”‚   â”‚   â”‚   â””â”€â”€ auth.guard.ts
â”‚   â”‚   â”œâ”€â”€ models/                      # Interfaces y tipos TypeScript
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ constants/                   # Constantes globales
â”‚   â”‚       â”œâ”€â”€ estados-encuesta.constants.ts
â”‚   â”‚       â”œâ”€â”€ roles.constants.ts
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                          # Recursos compartidos
â”‚   â”‚   â”œâ”€â”€ components/                  # Componentes reutilizables (opcional)
â”‚   â”‚   â”‚   â”œâ”€â”€ modal/
â”‚   â”‚   â”‚   â””â”€â”€ loading/
â”‚   â”‚   â”œâ”€â”€ pipes/                       # Pipes personalizados (opcional)
â”‚   â”‚   â””â”€â”€ constants/                   # Constantes compartidas
â”‚   â”‚
â”‚   â””â”€â”€ {feature-name}/                  # MÃ³dulos de funcionalidad
â”‚       â”œâ”€â”€ {feature}-list/              # Componente de listado
â”‚       â”‚   â”œâ”€â”€ {feature}-list.component.ts
â”‚       â”‚   â”œâ”€â”€ {feature}-list.component.html
â”‚       â”‚   â””â”€â”€ {feature}-list.component.css
â”‚       â”œâ”€â”€ {feature}-form/              # Componente de formulario
â”‚       â”‚   â”œâ”€â”€ {feature}-form.component.ts
â”‚       â”‚   â”œâ”€â”€ {feature}-form.component.html
â”‚       â”‚   â””â”€â”€ {feature}-form.component.css
â”‚       â””â”€â”€ {feature}-detail/            # Componente de detalle (opcional)
â”‚           â”œâ”€â”€ {feature}-detail.component.ts
â”‚           â”œâ”€â”€ {feature}-detail.component.html
â”‚           â””â”€â”€ {feature}-detail.component.css
â”‚
â”œâ”€â”€ environments/                        # Configuraciones por entorno
â”‚   â”œâ”€â”€ environment.ts                   # Development
â”‚   â””â”€â”€ environment.prod.ts              # Production
â”‚
â”œâ”€â”€ index.html                           # HTML principal
â”œâ”€â”€ main.ts                              # Punto de entrada de la aplicaciÃ³n
â””â”€â”€ styles.scss                          # Estilos globales
```

### Ejemplo de Feature Module

```
src/app/encuestas/
â”œâ”€â”€ encuestas-list/                      # Listado de encuestas
â”‚   â”œâ”€â”€ encuestas-list.component.ts
â”‚   â”œâ”€â”€ encuestas-list.component.html
â”‚   â””â”€â”€ encuestas-list.component.css
â”œâ”€â”€ encuesta-form/                       # Formulario de encuesta
â”‚   â”œâ”€â”€ encuesta-form.component.ts
â”‚   â”œâ”€â”€ encuesta-form.component.html
â”‚   â””â”€â”€ encuesta-form.component.css
â””â”€â”€ encuesta-detail/                     # Detalle de encuesta (opcional)
    â”œâ”€â”€ encuesta-detail.component.ts
    â”œâ”€â”€ encuesta-detail.component.html
    â””â”€â”€ encuesta-detail.component.css
```

---

## ğŸ“ Convenciones de CÃ³digo

### 1. **Nomenclatura**

#### Archivos
- **Components**: `{nombre}.component.ts` (kebab-case)
- **Services**: `{nombre}.service.ts` (kebab-case)
- **Interceptors**: `{nombre}.interceptor.ts` (kebab-case)
- **Guards**: `{nombre}.guard.ts` (kebab-case)
- **Models**: `index.ts` (todos los modelos en un solo archivo o por dominio)
- **Constants**: `{nombre}.constants.ts` (kebab-case)

#### Clases y Selectores
```typescript
// Components (PascalCase + Component)
@Component({
  selector: 'app-encuestas-list',  // kebab-case con prefijo 'app-'
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './encuestas-list.component.html',
  styleUrl: './encuestas-list.component.css'
})
export class EncuestasListComponent {}

// Services (PascalCase + Service)
@Injectable({
  providedIn: 'root'  // Siempre 'root' para servicios globales
})
export class EncuestasService {}
```

### 2. **Estructura de Services**

#### Service BÃ¡sico (GET/POST/PUT/DELETE)

```typescript
import { Injectable, inject } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../../environments/environment';
import { Recurso, PaginacionRespuesta } from '../models';

/**
 * Service para manejar operaciones CRUD de Recursos
 */
@Injectable({
  providedIn: 'root'
})
export class RecursosService {
  // âœ… USAR inject() en lugar de constructor injection (Angular 14+)
  private http = inject(HttpClient);
  private apiUrl = `${environment.apiUrl}/recursos`;

  /**
   * Listar recursos con paginaciÃ³n y filtros
   */
  listar(
    pagina: number = 1,
    limite: number = 10,
    filtros?: {
      nombre?: string;
      categoria?: string;
      activo?: boolean;
    }
  ): Observable<PaginacionRespuesta<Recurso>> {
    let params = new HttpParams()
      .set('pagina', pagina.toString())
      .set('limite', limite.toString());

    // Agregar filtros opcionales
    if (filtros?.nombre) {
      params = params.set('nombre', filtros.nombre);
    }
    if (filtros?.categoria) {
      params = params.set('categoria', filtros.categoria);
    }
    if (filtros?.activo !== undefined) {
      params = params.set('activo', filtros.activo.toString());
    }

    return this.http.get<PaginacionRespuesta<Recurso>>(this.apiUrl, { params });
  }

  /**
   * Obtener recurso por ID
   */
  obtenerPorId(id: number): Observable<Recurso> {
    return this.http.get<Recurso>(`${this.apiUrl}/${id}`);
  }

  /**
   * Crear nuevo recurso
   */
  crear(recurso: Partial<Recurso>): Observable<Recurso> {
    return this.http.post<Recurso>(this.apiUrl, recurso);
  }

  /**
   * Actualizar recurso existente
   */
  actualizar(id: number, recurso: Partial<Recurso>): Observable<Recurso> {
    return this.http.patch<Recurso>(`${this.apiUrl}/${id}`, recurso);
  }

  /**
   * Eliminar recurso (soft delete)
   */
  eliminar(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

#### Service con MÃ©todos Especiales

```typescript
import { Injectable, inject } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable, tap } from 'rxjs';
import { environment } from '../../../environments/environment';

@Injectable({
  providedIn: 'root'
})
export class EncuestasService {
  private http = inject(HttpClient);
  private apiUrl = `${environment.apiUrl}/encuestas`;

  /**
   * Cambiar estado de una encuesta
   */
  cambiarEstado(id: number, estadoId: number): Observable<Encuesta> {
    return this.http.patch<Encuesta>(
      `${this.apiUrl}/${id}/estados`,
      { estadoId }
    );
  }

  /**
   * Exportar datos a Excel/PDF
   * Retorna un Blob para descarga
   */
  exportar(filtros: any): Observable<Blob> {
    let params = new HttpParams();

    // Agregar todos los parÃ¡metros de filtros
    Object.keys(filtros).forEach(key => {
      if (filtros[key] !== null && filtros[key] !== undefined && filtros[key] !== '') {
        params = params.set(key, filtros[key].toString());
      }
    });

    return this.http.get(`${environment.apiUrl}/reportes/xlsx`, {
      params,
      responseType: 'blob'  // âš ï¸ Importante para descargar archivos
    });
  }
}
```

### 3. **Estructura de Components**

#### Component BÃ¡sico (Lista)

```typescript
import { Component, signal, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { RecursosService } from '../../core/services/recursos.service';
import { AuthService } from '../../core/services/auth.service';
import { Recurso, PaginacionRespuesta } from '../../core/models';

/**
 * Componente para listar recursos
 */
@Component({
  selector: 'app-recursos-list',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './recursos-list.component.html',
  styleUrl: './recursos-list.component.css'
})
export class RecursosListComponent implements OnInit {
  // âœ… USAR signals para estado reactivo (Angular 20+)
  recursos = signal<Recurso[]>([]);
  paginaActual = signal(1);
  totalPaginas = signal(0);
  cargando = signal(false);
  
  // Filtros (variables normales para ngModel)
  filtroNombre = '';
  filtroCategoria = '';

  // âœ… USAR inject() en constructor o como propiedad
  constructor(
    private recursosService: RecursosService,
    private authService: AuthService,
    private router: Router
  ) {}

  ngOnInit(): void {
    this.cargarRecursos();
  }

  /**
   * Cargar recursos desde el backend
   */
  cargarRecursos(): void {
    this.cargando.set(true);
    
    const filtros = {
      nombre: this.filtroNombre || undefined,
      categoria: this.filtroCategoria || undefined,
    };

    this.recursosService.listar(this.paginaActual(), 10, filtros).subscribe({
      next: (respuesta: PaginacionRespuesta<Recurso>) => {
        this.recursos.set(respuesta.data);
        this.totalPaginas.set(respuesta.totalPaginas);
        this.cargando.set(false);
      },
      error: (error) => {
        console.error('Error al cargar recursos:', error);
        this.cargando.set(false);
        // Mostrar mensaje de error al usuario
      }
    });
  }

  /**
   * Aplicar filtros y recargar
   */
  aplicarFiltros(): void {
    this.paginaActual.set(1); // Resetear a la primera pÃ¡gina
    this.cargarRecursos();
  }

  /**
   * Limpiar filtros
   */
  limpiarFiltros(): void {
    this.filtroNombre = '';
    this.filtroCategoria = '';
    this.paginaActual.set(1);
    this.cargarRecursos();
  }

  /**
   * Cambiar pÃ¡gina
   */
  cambiarPagina(pagina: number): void {
    this.paginaActual.set(pagina);
    this.cargarRecursos();
  }

  /**
   * Navegar al formulario de creaciÃ³n
   */
  nuevoRecurso(): void {
    this.router.navigate(['/recursos/nuevo']);
  }

  /**
   * Navegar al formulario de ediciÃ³n
   */
  editarRecurso(id: number): void {
    this.router.navigate(['/recursos', id, 'editar']);
  }

  /**
   * Eliminar recurso
   */
  eliminarRecurso(id: number): void {
    if (!confirm('Â¿EstÃ¡ seguro de eliminar este recurso?')) {
      return;
    }

    this.recursosService.eliminar(id).subscribe({
      next: () => {
        // Recargar lista
        this.cargarRecursos();
      },
      error: (error) => {
        console.error('Error al eliminar recurso:', error);
        alert('Error al eliminar el recurso');
      }
    });
  }
}
```

#### Component de Formulario

```typescript
import { Component, signal, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { ActivatedRoute, Router } from '@angular/router';
import { RecursosService } from '../../core/services/recursos.service';
import { Recurso } from '../../core/models';

@Component({
  selector: 'app-recurso-form',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './recurso-form.component.html',
  styleUrl: './recurso-form.component.css'
})
export class RecursoFormComponent implements OnInit {
  // Estado del formulario
  recurso: Recurso = {
    nombre: '',
    categoria: '',
    descripcion: '',
  };

  // Estados de UI
  guardando = signal(false);
  modoEdicion = signal(false);
  recursoId: number | null = null;

  // Errores de validaciÃ³n
  errores = {
    nombre: '',
    categoria: '',
  };

  constructor(
    private recursosService: RecursosService,
    private route: ActivatedRoute,
    private router: Router
  ) {}

  ngOnInit(): void {
    // Obtener ID de la ruta si existe
    const id = this.route.snapshot.paramMap.get('id');
    
    if (id) {
      this.recursoId = +id;
      this.modoEdicion.set(true);
      this.cargarRecurso(this.recursoId);
    }
  }

  /**
   * Cargar recurso para ediciÃ³n
   */
  cargarRecurso(id: number): void {
    this.recursosService.obtenerPorId(id).subscribe({
      next: (recurso) => {
        this.recurso = recurso;
      },
      error: (error) => {
        console.error('Error al cargar recurso:', error);
        alert('Error al cargar el recurso');
        this.router.navigate(['/recursos']);
      }
    });
  }

  /**
   * Validar formulario
   */
  validarFormulario(): boolean {
    let valido = true;

    // Resetear errores
    this.errores = {
      nombre: '',
      categoria: '',
    };

    // Validar nombre
    if (!this.recurso.nombre || this.recurso.nombre.trim() === '') {
      this.errores.nombre = 'El nombre es requerido';
      valido = false;
    }

    // Validar categorÃ­a
    if (!this.recurso.categoria) {
      this.errores.categoria = 'La categorÃ­a es requerida';
      valido = false;
    }

    return valido;
  }

  /**
   * Guardar recurso (crear o actualizar)
   */
  guardar(): void {
    if (!this.validarFormulario()) {
      return;
    }

    this.guardando.set(true);

    const operacion = this.modoEdicion()
      ? this.recursosService.actualizar(this.recursoId!, this.recurso)
      : this.recursosService.crear(this.recurso);

    operacion.subscribe({
      next: () => {
        this.guardando.set(false);
        this.router.navigate(['/recursos']);
      },
      error: (error) => {
        console.error('Error al guardar recurso:', error);
        this.guardando.set(false);
        
        // Manejar errores especÃ­ficos del backend
        if (error.status === 409) {
          this.errores.nombre = 'Ya existe un recurso con ese nombre';
        } else {
          alert('Error al guardar el recurso');
        }
      }
    });
  }

  /**
   * Cancelar y volver al listado
   */
  cancelar(): void {
    this.router.navigate(['/recursos']);
  }
}
```

### 4. **Estructura de Models (Interfaces)**

```typescript
// src/app/core/models/index.ts

/**
 * Interfaz base con campos de auditorÃ­a
 */
export interface AuditoriaEntity {
  fechaCreacion?: string;
  usuarioCreacion?: string;
  fechaModificacion?: string;
  usuarioModificacion?: string;
  indActivo?: number;
}

/**
 * Respuesta paginada genÃ©rica
 */
export interface PaginacionRespuesta<T> {
  data: T[];
  total: number;
  pagina: number;
  limite: number;
  totalPaginas: number;
}

/**
 * Interfaz de Recurso
 */
export interface Recurso extends AuditoriaEntity {
  recursoId?: number;
  nombre: string;
  categoria: string;
  descripcion?: string;
}

/**
 * Interfaz de Usuario
 */
export interface Usuario extends AuditoriaEntity {
  userId?: number;
  userUuid?: string;
  nombres: string;
  apepat: string;
  apemat: string;
  numdoc: string;
  tipodoc: string;
  username: string;
  roles?: Rol[];
}

/**
 * Interfaz de Rol
 */
export interface Rol extends AuditoriaEntity {
  rolId: number;
  descripcion: string;
}

/**
 * Request/Response de Login
 */
export interface LoginRequest {
  username: string;
  password: string;
}

export interface LoginResponse extends Usuario {
  token: string;
  fechaExpiracion: string;
}
```

### 5. **Estructura de Constants**

```typescript
// src/app/core/constants/estados-encuesta.constants.ts

/**
 * Estados de encuesta
 */
export const ESTADOS_ENCUESTA = {
  EN_REGISTRO: 1,
  EN_REVISION: 2,
  TRANSFERIDO: 3,
  EN_CORRECCION: 4,
  APROBADO: 5,
  OBSERVADA: 6,
} as const;

/**
 * Tipo para estados de encuesta
 */
export type EstadoEncuesta = typeof ESTADOS_ENCUESTA[keyof typeof ESTADOS_ENCUESTA];
```

```typescript
// src/app/core/constants/roles.constants.ts

/**
 * Roles del sistema
 */
export const ROLES = {
  ENCUESTADOR: 'Encuestador',
  ADMINISTRADOR: 'Administrador',
  VALIDADOR: 'Validador',
} as const;

/**
 * Tipo para los roles del sistema
 */
export type RolDescripcion = typeof ROLES[keyof typeof ROLES];
```

```typescript
// src/app/core/constants/index.ts

export * from './estados-encuesta.constants';
export * from './roles.constants';
```

### 6. **Interceptors**

#### Auth Interceptor (Functional)

```typescript
// src/app/core/interceptors/auth.interceptor.ts

import { HttpInterceptorFn } from '@angular/common/http';
import { inject } from '@angular/core';
import { AuthService } from '../services/auth.service';

/**
 * Interceptor funcional para agregar el token JWT a todas las requests HTTP
 * âœ… USAR HttpInterceptorFn (Angular 15+) en lugar de class-based interceptors
 */
export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const authService = inject(AuthService);
  const token = authService.getToken();

  // Si existe token, clonar la request y agregar el header Authorization
  if (token) {
    const clonedRequest = req.clone({
      setHeaders: {
        Authorization: `Bearer ${token}`,
      },
    });
    return next(clonedRequest);
  }

  // Si no hay token, continuar con la request original
  return next(req);
};
```

#### Error Interceptor (Opcional)

```typescript
// src/app/core/interceptors/error.interceptor.ts

import { HttpInterceptorFn } from '@angular/common/http';
import { inject } from '@angular/core';
import { Router } from '@angular/router';
import { catchError, throwError } from 'rxjs';

/**
 * Interceptor para manejar errores HTTP globalmente
 */
export const errorInterceptor: HttpInterceptorFn = (req, next) => {
  const router = inject(Router);

  return next(req).pipe(
    catchError((error) => {
      // Error de autenticaciÃ³n - redirigir a login
      if (error.status === 401) {
        // Limpiar token
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_data');
        // Redirigir a login
        router.navigate(['/inicio-sesion']);
      }

      // Error de permisos
      if (error.status === 403) {
        alert('No tiene permisos para realizar esta acciÃ³n');
      }

      // Error del servidor
      if (error.status >= 500) {
        console.error('Error del servidor:', error);
        alert('Error del servidor. Por favor, intente nuevamente.');
      }

      return throwError(() => error);
    })
  );
};
```

### 7. **Routing Configuration**

```typescript
// src/app/app.routes.ts

import { Routes } from '@angular/router';

/**
 * ConfiguraciÃ³n de rutas de la aplicaciÃ³n
 * âœ… USAR loadComponent para lazy loading (Angular 14+)
 */
export const routes: Routes = [
  // Ruta por defecto
  {
    path: '',
    redirectTo: '/inicio-sesion',
    pathMatch: 'full'
  },
  
  // Login
  {
    path: 'inicio-sesion',
    loadComponent: () => import('./auth/login/login.component')
      .then(m => m.LoginComponent)
  },
  
  // Recursos - Lista
  {
    path: 'recursos',
    loadComponent: () => import('./recursos/recursos-list/recursos-list.component')
      .then(m => m.RecursosListComponent)
  },
  
  // Recursos - Nuevo
  {
    path: 'recursos/nuevo',
    loadComponent: () => import('./recursos/recurso-form/recurso-form.component')
      .then(m => m.RecursoFormComponent)
  },
  
  // Recursos - Editar
  {
    path: 'recursos/:id/editar',
    loadComponent: () => import('./recursos/recurso-form/recurso-form.component')
      .then(m => m.RecursoFormComponent)
  },
  
  // 404 - Not Found
  {
    path: '**',
    redirectTo: '/inicio-sesion'
  }
];
```

### 8. **App Configuration**

```typescript
// src/app/app.config.ts

import {
  ApplicationConfig,
  provideBrowserGlobalErrorListeners,
  provideZonelessChangeDetection,
} from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient, withFetch, withInterceptors } from '@angular/common/http';
import { provideClientHydration, withEventReplay } from '@angular/platform-browser';

import { routes } from './app.routes';
import { authInterceptor } from './core/interceptors/auth.interceptor';
import { errorInterceptor } from './core/interceptors/error.interceptor';

/**
 * ConfiguraciÃ³n principal de la aplicaciÃ³n
 */
export const appConfig: ApplicationConfig = {
  providers: [
    // Error listeners globales
    provideBrowserGlobalErrorListeners(),
    
    // âœ… Zoneless Change Detection para mejor rendimiento
    provideZonelessChangeDetection(),
    
    // Router
    provideRouter(routes),
    
    // Hydration para SSR (opcional)
    provideClientHydration(withEventReplay()),
    
    // HttpClient con interceptores
    provideHttpClient(
      withFetch(),  // Usar Fetch API
      withInterceptors([
        authInterceptor,
        errorInterceptor,  // Opcional
      ])
    ),
  ],
};
```

### 9. **Environment Configuration**

```typescript
// src/environments/environment.ts (Development)

export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000/api',
};
```

```typescript
// src/environments/environment.prod.ts (Production)

export const environment = {
  production: true,
  apiUrl: 'https://api.md-research.com/api',
};
```

---

## ğŸ”„ Flujo de Datos

### Flujo Completo de una PeticiÃ³n

```
1. Usuario interactÃºa con la UI (click en botÃ³n)
   â†“
2. Component maneja el evento
   - Actualiza signals si es necesario
   - Valida datos bÃ¡sicos
   â†“
3. Component llama al Service
   - Pasa datos necesarios
   â†“
4. Service hace HTTP request
   - HttpClient envÃ­a request
   â†“
5. Interceptors procesan la request
   - authInterceptor: Agrega JWT token
   - errorInterceptor: Maneja errores (opcional)
   â†“
6. Request llega al Backend (NestJS API)
   â†“
7. Backend procesa y retorna respuesta
   â†“
8. Interceptors procesan la response
   â†“
9. Service recibe response (Observable)
   â†“
10. Component se subscribe al Observable
    - next: Actualiza signals con datos
    - error: Maneja error y muestra mensaje
    â†“
11. Angular detecta cambios (via Signals)
    - Template se re-renderiza automÃ¡ticamente
    â†“
12. UI actualizada mostrada al usuario
```

### Ejemplo de Flujo Completo

```typescript
// 1. Usuario hace click en "Guardar"
// Template
<button (click)="guardarRecurso()">Guardar</button>

// 2. Component maneja el evento
guardarRecurso(): void {
  // Validar
  if (!this.validarFormulario()) {
    return;
  }
  
  // Actualizar UI
  this.guardando.set(true);
  
  // 3. Llamar al service
  this.recursosService.crear(this.recurso).subscribe({
    // 10. Manejar respuesta
    next: (recursoCreado) => {
      // 11. Actualizar signals (detecciÃ³n automÃ¡tica de cambios)
      this.guardando.set(false);
      // Navegar a lista
      this.router.navigate(['/recursos']);
    },
    error: (error) => {
      console.error('Error:', error);
      this.guardando.set(false);
      alert('Error al guardar');
    }
  });
}

// 4-9. Service, Interceptors, Backend, etc.
```

---

## ğŸ¨ Patrones de UI con Signals

### 1. **Estado de Carga**

```typescript
export class RecursosListComponent {
  recursos = signal<Recurso[]>([]);
  cargando = signal(false);

  cargarRecursos(): void {
    this.cargando.set(true);
    
    this.recursosService.listar().subscribe({
      next: (respuesta) => {
        this.recursos.set(respuesta.data);
        this.cargando.set(false);
      },
      error: () => {
        this.cargando.set(false);
      }
    });
  }
}
```

```html
<!-- Template -->
<div *ngIf="cargando()">
  Cargando...
</div>

<div *ngIf="!cargando()">
  <div *ngFor="let recurso of recursos()">
    {{ recurso.nombre }}
  </div>
</div>
```

### 2. **Modales con Signals**

```typescript
export class RecursosListComponent {
  mostrarModal = signal(false);
  recursoSeleccionado = signal<Recurso | null>(null);

  abrirModal(recurso: Recurso): void {
    this.recursoSeleccionado.set(recurso);
    this.mostrarModal.set(true);
  }

  cerrarModal(): void {
    this.mostrarModal.set(false);
    this.recursoSeleccionado.set(null);
  }
}
```

```html
<!-- Template -->
<div *ngIf="mostrarModal()" class="modal">
  <div class="modal-content">
    <h2>{{ recursoSeleccionado()?.nombre }}</h2>
    <button (click)="cerrarModal()">Cerrar</button>
  </div>
</div>
```

### 3. **Filtros Reactivos**

```typescript
export class RecursosListComponent {
  recursos = signal<Recurso[]>([]);
  filtroNombre = '';
  filtroCategoria = '';

  // Signal computado para recursos filtrados
  recursosFiltrados = computed(() => {
    const recursos = this.recursos();
    let filtrados = recursos;

    if (this.filtroNombre) {
      filtrados = filtrados.filter(r =>
        r.nombre.toLowerCase().includes(this.filtroNombre.toLowerCase())
      );
    }

    if (this.filtroCategoria) {
      filtrados = filtrados.filter(r => r.categoria === this.filtroCategoria);
    }

    return filtrados;
  });
}
```

```html
<!-- Template -->
<input [(ngModel)]="filtroNombre" placeholder="Buscar por nombre">
<select [(ngModel)]="filtroCategoria">
  <option value="">Todas</option>
  <option value="A">CategorÃ­a A</option>
  <option value="B">CategorÃ­a B</option>
</select>

<div *ngFor="let recurso of recursosFiltrados()">
  {{ recurso.nombre }}
</div>
```

---

## ğŸ“‹ Ejemplos Completos

### Ejemplo 1: MÃ³dulo de AutenticaciÃ³n

#### Service

```typescript
// src/app/core/services/auth.service.ts

import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, tap } from 'rxjs';
import { environment } from '../../../environments/environment';
import { LoginRequest, LoginResponse } from '../models';

@Injectable({
  providedIn: 'root',
})
export class AuthService {
  private http = inject(HttpClient);
  private apiUrl = `${environment.apiUrl}/usuarios`;
  private readonly TOKEN_KEY = 'auth_token';
  private readonly USER_KEY = 'user_data';

  /**
   * Iniciar sesiÃ³n
   */
  login(credentials: LoginRequest): Observable<LoginResponse> {
    return this.http.post<LoginResponse>(`${this.apiUrl}/inicio-sesion`, credentials).pipe(
      tap(response => {
        this.setToken(response.token);
        this.setUserData(response);
      })
    );
  }

  /**
   * Cerrar sesiÃ³n
   */
  logout(): Observable<any> {
    return this.http.post(`${this.apiUrl}/cierre-sesion`, {}).pipe(
      tap(() => {
        this.clearStorage();
      })
    );
  }

  /**
   * Obtener token
   */
  getToken(): string | null {
    return localStorage.getItem(this.TOKEN_KEY);
  }

  /**
   * Obtener datos del usuario
   */
  getUserData(): LoginResponse | null {
    const userData = localStorage.getItem(this.USER_KEY);
    return userData ? JSON.parse(userData) : null;
  }

  /**
   * Verificar si estÃ¡ autenticado
   */
  isAuthenticated(): boolean {
    const token = this.getToken();
    if (!token) {
      return false;
    }

    const userData = this.getUserData();
    if (userData && userData.fechaExpiracion) {
      const expirationDate = new Date(userData.fechaExpiracion);
      return expirationDate > new Date();
    }

    return false;
  }

  /**
   * Obtener rol del usuario
   */
  getRolDescripcion(): string {
    const userData = this.getUserData();
    if (userData?.roles && userData.roles.length > 0) {
      return userData.roles[0].descripcion;
    }
    return 'Usuario';
  }

  private setToken(token: string): void {
    localStorage.setItem(this.TOKEN_KEY, token);
  }

  private setUserData(userData: LoginResponse): void {
    localStorage.setItem(this.USER_KEY, JSON.stringify(userData));
  }

  private clearStorage(): void {
    localStorage.removeItem(this.TOKEN_KEY);
    localStorage.removeItem(this.USER_KEY);
  }
}
```

#### Component

```typescript
// src/app/auth/login/login.component.ts

import { Component, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService } from '../../core/services/auth.service';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.css']
})
export class LoginComponent {
  // Datos del formulario
  credentials = {
    username: '',
    password: ''
  };

  // Estados de UI
  isLoading = signal(false);
  
  // Errores de validaciÃ³n
  usernameError = '';
  passwordError = '';

  constructor(
    private router: Router,
    private authService: AuthService
  ) {}

  /**
   * Manejar submit del formulario
   */
  onSubmit(): void {
    // Limpiar errores previos
    this.usernameError = '';
    this.passwordError = '';
    
    // ValidaciÃ³n bÃ¡sica
    if (!this.credentials.username || !this.credentials.password) {
      if (!this.credentials.username) {
        this.usernameError = 'El usuario es requerido';
      }
      if (!this.credentials.password) {
        this.passwordError = 'La contraseÃ±a es requerida';
      }
      return;
    }

    // Iniciar proceso de login
    this.isLoading.set(true);

    this.authService.login(this.credentials).subscribe({
      next: (response) => {
        console.log('Login exitoso:', response);
        // Navegar a la pÃ¡gina principal
        setTimeout(() => {
          this.router.navigate(['/encuestas']);
        }, 500);
      },
      error: (error) => {
        console.error('Error en login:', error);
        this.isLoading.set(false);
        
        // Manejar diferentes tipos de errores
        if (error.status === 401) {
          this.usernameError = 'Usuario incorrecto';
          this.passwordError = 'ContraseÃ±a incorrecta';
        } else if (error.status === 400) {
          this.usernameError = error.error?.detalle || 'Usuario inactivo o datos invÃ¡lidos';
        } else if (error.status === 0) {
          this.usernameError = 'No se pudo conectar con el servidor';
        } else {
          this.usernameError = 'Error al iniciar sesiÃ³n';
        }
      }
    });
  }
}
```

#### Template

```html
<!-- src/app/auth/login/login.component.html -->

<div class="login-container">
  <div class="login-card">
    <h1>Iniciar SesiÃ³n</h1>
    
    <form (ngSubmit)="onSubmit()">
      <!-- Username -->
      <div class="form-group">
        <label for="username">Usuario</label>
        <input
          type="text"
          id="username"
          name="username"
          [(ngModel)]="credentials.username"
          [class.error]="usernameError"
          [disabled]="isLoading()"
          placeholder="Ingrese su usuario"
        />
        <span *ngIf="usernameError" class="error-message">
          {{ usernameError }}
        </span>
      </div>

      <!-- Password -->
      <div class="form-group">
        <label for="password">ContraseÃ±a</label>
        <input
          type="password"
          id="password"
          name="password"
          [(ngModel)]="credentials.password"
          [class.error]="passwordError"
          [disabled]="isLoading()"
          placeholder="Ingrese su contraseÃ±a"
        />
        <span *ngIf="passwordError" class="error-message">
          {{ passwordError }}
        </span>
      </div>

      <!-- Submit -->
      <button
        type="submit"
        [disabled]="isLoading()"
        class="btn-primary"
      >
        <span *ngIf="!isLoading()">Iniciar SesiÃ³n</span>
        <span *ngIf="isLoading()">Cargando...</span>
      </button>
    </form>
  </div>
</div>
```

### Ejemplo 2: CRUD Completo con PaginaciÃ³n

#### Service

```typescript
// Ya mostrado en secciones anteriores
// Ver: Estructura de Services -> Service BÃ¡sico
```

#### Component Lista

```typescript
// Ya mostrado en secciones anteriores
// Ver: Estructura de Components -> Component BÃ¡sico (Lista)
```

#### Template Lista

```html
<!-- src/app/recursos/recursos-list/recursos-list.component.html -->

<div class="page-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Recursos</h1>
    <button (click)="nuevoRecurso()" class="btn-primary">
      Nuevo Recurso
    </button>
  </div>

  <!-- Filtros -->
  <div class="filters-container">
    <div class="filter-group">
      <input
        [(ngModel)]="filtroNombre"
        placeholder="Buscar por nombre"
        (keyup.enter)="aplicarFiltros()"
      />
    </div>
    
    <div class="filter-group">
      <select [(ngModel)]="filtroCategoria">
        <option value="">Todas las categorÃ­as</option>
        <option value="A">CategorÃ­a A</option>
        <option value="B">CategorÃ­a B</option>
      </select>
    </div>

    <button (click)="aplicarFiltros()" class="btn-secondary">
      Buscar
    </button>
    
    <button (click)="limpiarFiltros()" class="btn-outline">
      Limpiar
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando()" class="loading-container">
    Cargando recursos...
  </div>

  <!-- Tabla -->
  <div *ngIf="!cargando()" class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>CategorÃ­a</th>
          <th>Fecha CreaciÃ³n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let recurso of recursos()">
          <td>{{ recurso.recursoId }}</td>
          <td>{{ recurso.nombre }}</td>
          <td>{{ recurso.categoria }}</td>
          <td>{{ recurso.fechaCreacion | date:'dd/MM/yyyy' }}</td>
          <td>
            <button (click)="editarRecurso(recurso.recursoId!)" class="btn-icon">
              Editar
            </button>
            <button (click)="eliminarRecurso(recurso.recursoId!)" class="btn-icon-danger">
              Eliminar
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Sin resultados -->
    <div *ngIf="recursos().length === 0" class="no-results">
      No se encontraron recursos
    </div>
  </div>

  <!-- PaginaciÃ³n -->
  <div *ngIf="totalPaginas() > 1" class="pagination">
    <button
      (click)="cambiarPagina(paginaActual() - 1)"
      [disabled]="paginaActual() === 1"
      class="btn-pagination"
    >
      Anterior
    </button>

    <span class="pagination-info">
      PÃ¡gina {{ paginaActual() }} de {{ totalPaginas() }}
    </span>

    <button
      (click)="cambiarPagina(paginaActual() + 1)"
      [disabled]="paginaActual() === totalPaginas()"
      class="btn-pagination"
    >
      Siguiente
    </button>
  </div>
</div>
```

---

## âœ… Checklist de ImplementaciÃ³n

### Para Crear un Nuevo MÃ³dulo/Feature

- [ ] **1. Crear carpeta del feature**
  - [ ] `src/app/{feature-name}/`

- [ ] **2. Crear Service**
  - [ ] Crear `src/app/core/services/{feature}.service.ts`
  - [ ] Usar `@Injectable({ providedIn: 'root' })`
  - [ ] Usar `inject(HttpClient)`
  - [ ] Implementar mÃ©todos CRUD bÃ¡sicos
  - [ ] Documentar con JSDoc

- [ ] **3. Crear Models**
  - [ ] Agregar interfaces en `src/app/core/models/index.ts`
  - [ ] Extender de `AuditoriaEntity` si aplica
  - [ ] Exportar interfaces

- [ ] **4. Crear Component de Lista**
  - [ ] Crear carpeta `{feature}-list/`
  - [ ] Crear archivos: `.ts`, `.html`, `.css`
  - [ ] Marcar como `standalone: true`
  - [ ] Importar `CommonModule` y `FormsModule`
  - [ ] Usar signals para estado reactivo
  - [ ] Implementar paginaciÃ³n
  - [ ] Implementar filtros

- [ ] **5. Crear Component de Formulario**
  - [ ] Crear carpeta `{feature}-form/`
  - [ ] Crear archivos: `.ts`, `.html`, `.css`
  - [ ] Marcar como `standalone: true`
  - [ ] Implementar validaciones
  - [ ] Manejar modo creaciÃ³n y ediciÃ³n
  - [ ] Manejar errores del backend

- [ ] **6. Agregar Rutas**
  - [ ] Actualizar `src/app/app.routes.ts`
  - [ ] Usar `loadComponent` para lazy loading
  - [ ] Definir rutas con parÃ¡metros si es necesario

- [ ] **7. Testing**
  - [ ] Probar creaciÃ³n
  - [ ] Probar ediciÃ³n
  - [ ] Probar eliminaciÃ³n
  - [ ] Probar filtros y paginaciÃ³n
  - [ ] Probar manejo de errores

---

## ğŸš¨ Mejores PrÃ¡cticas

### âœ… DO (Hacer)

1. **Usar Standalone Components** - No crear NgModules
2. **Usar Signals** - Para estado reactivo (Angular 20+)
3. **Usar inject()** - En lugar de constructor injection
4. **Lazy Loading** - Usar `loadComponent` en rutas
5. **Functional Interceptors** - Usar `HttpInterceptorFn`
6. **Zoneless** - Configurar `provideZonelessChangeDetection()`
7. **ValidaciÃ³n en Formularios** - Validar antes de enviar
8. **Manejo de Errores** - Siempre manejar errores en subscribe
9. **Loading States** - Mostrar indicadores de carga
10. **TypeScript Strict** - Mantener `strict: true` en tsconfig
11. **DocumentaciÃ³n** - Comentar mÃ©todos complejos con JSDoc
12. **Nomenclatura Consistente** - Seguir convenciones de Angular

### âŒ DON'T (No Hacer)

1. **NO usar NgModules** - Todo debe ser standalone
2. **NO usar Zone.js** - EstÃ¡ deshabilitado (zoneless)
3. **NO manipular DOM directamente** - Usar data binding
4. **NO poner lÃ³gica en Templates** - Mover a component
5. **NO hardcodear URLs** - Usar `environment.apiUrl`
6. **NO ignorar errores** - Siempre manejarlos
7. **NO crear Services sin `providedIn`** - Siempre usar `providedIn: 'root'`
8. **NO mezclar estilos** - Un estilo por componente
9. **NO olvidar unsubscribe** - Aunque con pipe async/signals es automÃ¡tico
10. **NO usar `any`** - Tipar correctamente todas las variables

---

## ğŸ¯ Resumen de Diferencias con Angular Tradicional

### Cambios Principales (Angular 20+)

| CaracterÃ­stica | Tradicional (Angular <14) | Moderno (Angular 20+) |
|---|---|---|
| **Modules** | NgModules obligatorios | Standalone components |
| **Estado** | Variables + OnPush | Signals (reactivo) |
| **Change Detection** | Zone.js | Zoneless |
| **Injection** | Constructor injection | `inject()` function |
| **Interceptors** | Class-based | Functional (`HttpInterceptorFn`) |
| **Routing** | `loadChildren` | `loadComponent` |
| **HTTP** | Observable manual | Observable + signals |

### Ejemplo de MigraciÃ³n

**Antes (Angular <14):**
```typescript
@Component({
  selector: 'app-recursos',
  templateUrl: './recursos.component.html',
})
export class RecursosComponent implements OnInit {
  recursos: Recurso[] = [];
  cargando = false;

  constructor(private recursosService: RecursosService) {}

  ngOnInit() {
    this.cargarRecursos();
  }

  cargarRecursos() {
    this.cargando = true;
    this.recursosService.listar().subscribe(data => {
      this.recursos = data;
      this.cargando = false;
    });
  }
}
```

**Ahora (Angular 20+):**
```typescript
@Component({
  selector: 'app-recursos',
  standalone: true,  // âœ… Standalone
  imports: [CommonModule],
  templateUrl: './recursos.component.html',
})
export class RecursosComponent implements OnInit {
  // âœ… Signals para estado reactivo
  recursos = signal<Recurso[]>([]);
  cargando = signal(false);

  // âœ… inject() en lugar de constructor
  private recursosService = inject(RecursosService);

  ngOnInit() {
    this.cargarRecursos();
  }

  cargarRecursos() {
    this.cargando.set(true);
    this.recursosService.listar().subscribe(data => {
      this.recursos.set(data);
      this.cargando.set(false);
    });
  }
}
```

---

## ğŸ“š Recursos Adicionales

### DocumentaciÃ³n Oficial
- [Angular Official Docs](https://angular.dev)
- [Angular Signals](https://angular.dev/guide/signals)
- [Standalone Components](https://angular.dev/guide/components/importing)
- [HttpClient](https://angular.dev/guide/http)

### Archivos de ConfiguraciÃ³n
- `angular.json` - ConfiguraciÃ³n de Angular CLI
- `tsconfig.json` - ConfiguraciÃ³n de TypeScript
- `package.json` - Dependencias del proyecto

### Comandos Ãštiles

```bash
# Desarrollo
npm start                    # Iniciar servidor de desarrollo
ng serve                     # Iniciar servidor (alternativa)

# Build
npm run build                # Build para producciÃ³n
ng build                     # Build (alternativa)

# Generar componentes/servicios
ng generate component nombre           # Generar componente
ng generate service nombre             # Generar servicio
ng g c nombre --standalone             # Generar standalone component

# Testing
npm test                     # Ejecutar tests
ng test                      # Tests (alternativa)
```

---

## ğŸ‰ ConclusiÃ³n

Esta estructura estÃ¡ndar estÃ¡ diseÃ±ada para:

- âœ… Aprovechar las Ãºltimas caracterÃ­sticas de Angular 20+
- âœ… Mantener cÃ³digo limpio y organizado
- âœ… Facilitar el mantenimiento y escalabilidad
- âœ… Asegurar consistencia en todo el proyecto
- âœ… Mejorar el rendimiento (Signals + Zoneless)
- âœ… Simplificar el desarrollo (Standalone Components)

**Referencias principales**: 
- `AuthService` y `LoginComponent` - AutenticaciÃ³n completa
- `EncuestasService` y `EncuestasListComponent` - CRUD con paginaciÃ³n
- `authInterceptor` - Interceptor funcional moderno

Para cualquier duda, consultar estos componentes como ejemplos completos y funcionales de esta estructura.
