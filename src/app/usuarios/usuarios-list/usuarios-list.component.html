<div class="layout-container">
  <app-sidebar />

  <!-- Main Content -->
  <main class="main-content">
    <div class="usuarios-page">
  <!-- Header -->
  <app-page-header title="Gestión de Usuarios">
    <span class="total-usuarios">Total: {{ total() }} usuarios</span>
    <app-user-menu />
  </app-page-header>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="filtros-row">
        <div class="filtro-group">
          <label for="filtroNombre">Nombre</label>
          <input
            id="filtroNombre"
            type="text"
            class="form-control"
            [(ngModel)]="filtroNombre"
            placeholder="Buscar por nombre..."
          />
        </div>

        <div class="filtro-group">
          <label for="filtroUsername">Username</label>
          <input
            id="filtroUsername"
            type="text"
            class="form-control"
            [(ngModel)]="filtroUsername"
            placeholder="Buscar por username..."
          />
        </div>

        <div class="filtro-group">
          <label for="filtroActivo">Estado</label>
          <select id="filtroActivo" class="form-control" [(ngModel)]="filtroActivo">
            <option value="todos">Todos</option>
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
          </select>
        </div>

        <div class="filtro-group-buttons">
          <button class="btn-limpiar" (click)="limpiarFiltros()">
            Limpiar Filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando()" class="loading">
    <p>Cargando usuarios...</p>
  </div>

  <!-- Tabla -->
  <div *ngIf="!cargando()" class="card">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Avatar</th>
            <th>Nombre Completo</th>
            <th>Username</th>
            <th>Documento</th>
            <th>Roles</th>
            <th>Estado</th>
            <th>Fecha Creación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (usuario of usuariosFiltrados(); track usuario.userId) {
            <tr>
              <!-- Avatar -->
              <td>
                <div class="user-avatar">
                  {{ obtenerIniciales(usuario) }}
                </div>
              </td>

              <!-- Nombre Completo -->
              <td class="col-nombre">
                <div class="user-name-cell">
                  <span class="user-name">{{ obtenerNombreCompleto(usuario) }}</span>
                  <span class="user-uuid">{{ usuario.userUuid }}</span>
                </div>
              </td>

              <!-- Username -->
              <td>{{ usuario.username }}</td>

              <!-- Documento -->
              <td>
                <div class="documento-cell">
                  <span class="tipo-doc">{{ usuario.tipodoc }}</span>
                  <span class="num-doc">{{ usuario.numdoc }}</span>
                </div>
              </td>

              <!-- Roles -->
              <td>
                <div class="roles-cell">
                  @for (rol of usuario.roles; track rol.rolId) {
                    <span class="badge-rol">{{ rol.descripcion }}</span>
                  }
                  @empty {
                    <span class="text-muted">Sin rol</span>
                  }
                </div>
              </td>

              <!-- Estado -->
              <td>
                <span [class]="obtenerEstadoClass(usuario)">
                  {{ obtenerEstadoTexto(usuario) }}
                </span>
              </td>

              <!-- Fecha Creación -->
              <td>
                {{ usuario.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
              </td>

              <!-- Acciones -->
              <td>
                <div class="acciones-container">
                  <!-- Botón Ver Detalle -->
                  <button
                    class="btn-icon btn-icon-primary"
                    (click)="verDetalleUsuario(usuario.userUuid)"
                    title="Ver detalle"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                      <path d="M1 8s3-5 7-5 7 5 7 5-3 5-7 5-7-5-7-5z" stroke-width="2"/>
                      <circle cx="8" cy="8" r="2" stroke-width="2"/>
                    </svg>
                  </button>

                  <!-- Botón Activar/Desactivar -->
                  <button
                    [class]="usuario.indActivo === 1 ? 'btn-icon btn-icon-danger' : 'btn-icon btn-icon-success'"
                    (click)="solicitarCambioEstado(usuario)"
                    [title]="usuario.indActivo === 1 ? 'Desactivar usuario' : 'Activar usuario'"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                      @if (usuario.indActivo === 1) {
                        <!-- Icono de desactivar -->
                        <path d="M8 1v14M1 8h14" stroke-width="2"/>
                      } @else {
                        <!-- Icono de activar -->
                        <circle cx="8" cy="8" r="7" stroke-width="2"/>
                        <path d="M5 8l2 2 4-4" stroke-width="2"/>
                      }
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
          @empty {
            <tr>
              <td colspan="8" class="empty-message">
                No se encontraron usuarios
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginación -->
  <div *ngIf="totalPaginas() > 1" class="pagination">
    <button
      (click)="cambiarPagina(paginaActual() - 1)"
      [disabled]="paginaActual() === 1"
      class="btn-pagination"
    >
      Anterior
    </button>

    <span class="pagination-info">
      Página {{ paginaActual() }} de {{ totalPaginas() }}
    </span>

    <button
      (click)="cambiarPagina(paginaActual() + 1)"
      [disabled]="paginaActual() === totalPaginas()"
      class="btn-pagination"
    >
      Siguiente
    </button>
  </div>
    </div>
  </main>
</div>

@if (mostrarDetalleModal()) {
  <div class="modal-backdrop" (click)="cerrarDetalleModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Detalle de Usuario</h2>
        <button class="modal-close" (click)="cerrarDetalleModal()" aria-label="Cerrar">
          ×
        </button>
      </div>

      <div class="modal-body">
        @if (cargandoDetalle()) {
          <div class="modal-loading">Cargando detalle...</div>
        } @else if (errorDetalle()) {
          <div class="modal-error">{{ errorDetalle() }}</div>
        } @else if (usuarioDetalle()) {
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Nombre completo</span>
              <span class="detail-value">{{ obtenerNombreCompleto(usuarioDetalle()!) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Usuario</span>
              <span class="detail-value">{{ usuarioDetalle()!.username }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">UUID</span>
              <span class="detail-value">{{ usuarioDetalle()!.userUuid }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">ID interno</span>
              <span class="detail-value">{{ usuarioDetalle()!.userId }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Documento</span>
              <span class="detail-value">
                {{ usuarioDetalle()!.tipodoc }} - {{ usuarioDetalle()!.numdoc }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Estado</span>
              <span class="detail-value">
                <span [class]="obtenerEstadoClass(usuarioDetalle()!)">
                  {{ obtenerEstadoTexto(usuarioDetalle()!) }}
                </span>
              </span>
            </div>
            <div class="detail-item detail-item-full">
              <span class="detail-label">Roles</span>
              <span class="detail-value">
                @if (usuarioDetalle()!.roles.length) {
                  <span class="detail-roles">
                    @for (rol of usuarioDetalle()!.roles; track rol.rolId) {
                      <span class="badge-rol">{{ rol.descripcion }}</span>
                    }
                  </span>
                } @else {
                  <span class="text-muted">Sin rol</span>
                }
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Fecha creación</span>
              <span class="detail-value">
                {{ usuarioDetalle()!.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Usuario creación</span>
              <span class="detail-value">{{ usuarioDetalle()!.usuarioCreacion }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Fecha modificación</span>
              <span class="detail-value">
                {{ usuarioDetalle()!.fechaModificacion | date:'dd/MM/yyyy HH:mm' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Usuario modificación</span>
              <span class="detail-value">{{ usuarioDetalle()!.usuarioModificacion }}</span>
            </div>
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="cerrarDetalleModal()">Cerrar</button>
      </div>
    </div>
  </div>
}

@if (mostrarConfirmacionEstado()) {
  <div class="modal-backdrop" (click)="cerrarModalEstado()">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Confirmar acción</h2>
        <button class="modal-close" (click)="cerrarModalEstado()" aria-label="Cerrar">
          ×
        </button>
      </div>

      <div class="modal-body">
        <p class="confirm-text">
          ¿Deseas {{ obtenerAccionEstado() }} el usuario
          <strong>{{ usuarioEstadoPendiente()?.username }}</strong>?
        </p>
        @if (errorCambioEstado()) {
          <div class="modal-error">{{ errorCambioEstado() }}</div>
        }
      </div>

      <div class="modal-footer modal-actions">
        <button class="btn-secondary" (click)="cerrarModalEstado()" [disabled]="cambiandoEstado()">
          Cancelar
        </button>
        <button class="btn-primary" (click)="confirmarCambioEstado()" [disabled]="cambiandoEstado()">
          @if (cambiandoEstado()) {
            Procesando...
          } @else {
            Confirmar
          }
        </button>
      </div>
    </div>
  </div>
}
