<div class="layout-container">
  <app-sidebar />

  <main class="main-content">
    <div class="empresas-page">
      <app-page-header
        title="Detalle de Empresa"
        subtitle="Información completa de la empresa seleccionada">
        @if (!modoEdicion()) {
          <button type="button" class="btn btn-primary" (click)="activarEdicion()">
            Editar empresa
          </button>
        }
        <button type="button" class="btn btn-outline" (click)="volverListado()">
          Volver al listado
        </button>
        <app-user-menu />
      </app-page-header>

      @if (exitoEdicion()) {
        <div class="alert alert-success">{{ exitoEdicion() }}</div>
      }

      @if (error()) {
        <div class="alert alert-danger">
          {{ error() }}
        </div>
      }

      @if (cargando()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Cargando detalle...</p>
        </div>
      }

      @if (!cargando() && empresa()) {
        <div class="detail-sections">

          <!-- ═══ MODO VISTA ═══ -->
          @if (!modoEdicion()) {
            <div class="detail-card">
              <h2 class="detail-title">Datos Generales</h2>
              <div class="detail-row">
                <span class="detail-label">RUC</span>
                <span class="detail-value">{{ empresa()!.ruc }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Razón Social</span>
                <span class="detail-value">{{ empresa()!.razonSocial }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Tipo Empresa</span>
                <span class="detail-value">{{ obtenerNombreTipoEmpresa(empresa()!.tipoEmpresaId) }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Tamaño Empresa</span>
                <span class="detail-value">{{ empresa()!.tamanoEmpresaTop10k || 'N/A' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Actividad Económica</span>
                <span class="detail-value">{{ empresa()!.actividadEconomica || 'N/A' }}</span>
              </div>
            </div>

            <div class="detail-card">
              <h2 class="detail-title">Dirección</h2>
              @if (empresa()!.direccion) {
                <div class="detail-row">
                  <span class="detail-label">Dirección</span>
                  <span class="detail-value">{{ empresa()!.direccion!.direc || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">País</span>
                  <span class="detail-value">{{ empresa()!.direccion!.descPais || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Departamento</span>
                  <span class="detail-value">{{ empresa()!.direccion!.descDepartamento || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Provincia</span>
                  <span class="detail-value">{{ empresa()!.direccion!.descProvincia || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Distrito</span>
                  <span class="detail-value">{{ empresa()!.direccion!.descDistrito || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Tipo Vía</span>
                  <span class="detail-value">{{ empresa()!.direccion!.tipoVia || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Nombre Vía</span>
                  <span class="detail-value">{{ empresa()!.direccion!.nombreVia || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Número Vía</span>
                  <span class="detail-value">{{ empresa()!.direccion!.numeroVia || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Referencia</span>
                  <span class="detail-value">{{ empresa()!.direccion!.referencia || 'N/A' }}</span>
                </div>
              } @else {
                <div class="detail-empty">Sin dirección registrada</div>
              }
            </div>
          }

          <!-- ═══ MODO EDICIÓN ═══ -->
          @if (modoEdicion()) {
            <div class="detail-card">
              <h2 class="detail-title">Editar Empresa</h2>

              @if (errorEdicion()) {
                <div class="alert alert-danger">{{ errorEdicion() }}</div>
              }

              <div class="edit-form">
                <div class="edit-section-title">Datos Generales</div>
                <div class="edit-grid">
                  <div class="edit-field">
                    <label class="edit-label">RUC</label>
                    <input class="edit-input" type="text" maxlength="20" [(ngModel)]="formEdicion.ruc" placeholder="RUC de la empresa" />
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Razón Social</label>
                    <input class="edit-input" type="text" maxlength="250" [(ngModel)]="formEdicion.razonSocial" placeholder="Razón social" />
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Tipo de Empresa</label>
                    <select class="edit-select" [(ngModel)]="formEdicion.tipoEmpresaId">
                      <option [ngValue]="null">Seleccione tipo</option>
                      @for (tipo of tiposEmpresa(); track tipo.tipoEmpresaId) {
                        <option [ngValue]="tipo.tipoEmpresaId">{{ tipo.descripcionTipoEmpresa }}</option>
                      }
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Tamaño Empresa</label>
                    <input class="edit-input" type="text" maxlength="50" [(ngModel)]="formEdicion.tamanoEmpresaTop10k" placeholder="Ej: Top 10k" />
                  </div>
                  <div class="edit-field edit-field--full">
                    <label class="edit-label">Actividad Económica</label>
                    <input class="edit-input" type="text" maxlength="250" [(ngModel)]="formEdicion.actividadEconomica" placeholder="Actividad económica" />
                  </div>
                </div>

                <div class="edit-section-title">Dirección</div>
                <div class="edit-grid">
                  <div class="edit-field edit-field--full">
                    <label class="edit-label">Dirección</label>
                    <input class="edit-input" type="text" maxlength="1000" [(ngModel)]="formEdicion.direccion.direc" placeholder="Dirección completa" />
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">País</label>
                    <select class="edit-select" [(ngModel)]="formEdicion.direccion.codPais" (change)="onPaisChange()">
                      <option value="">Seleccione país</option>
                      @for (pais of paises; track pais.paisId) {
                        <option [value]="pais.codPais">{{ pais.descPais }}</option>
                      }
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Departamento</label>
                    <select class="edit-select" [(ngModel)]="formEdicion.direccion.codDepartamento" (change)="onDepartamentoChange()" [disabled]="!formEdicion.direccion.codPais">
                      <option value="">Seleccione departamento</option>
                      @for (dep of departamentos; track dep.departamentoId) {
                        <option [value]="dep.codDepartamento">{{ dep.descDepartamento }}</option>
                      }
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Provincia</label>
                    <select class="edit-select" [(ngModel)]="formEdicion.direccion.codProvincia" (change)="onProvinciaChange()" [disabled]="!formEdicion.direccion.codDepartamento">
                      <option value="">Seleccione provincia</option>
                      @for (prov of provincias; track prov.provinciaId) {
                        <option [value]="prov.codProvincia">{{ prov.descProvincia }}</option>
                      }
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Distrito</label>
                    <select class="edit-select" [(ngModel)]="formEdicion.direccion.codDistrito" [disabled]="!formEdicion.direccion.codProvincia">
                      <option value="">Seleccione distrito</option>
                      @for (dist of distritos; track dist.distritoId) {
                        <option [value]="dist.codDistrito">{{ dist.descDistrito }}</option>
                      }
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Tipo Vía</label>
                    <input class="edit-input" type="text" maxlength="20" [(ngModel)]="formEdicion.direccion.tipoVia" placeholder="Ej: AV, JR, CA" />
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Nombre Vía</label>
                    <input class="edit-input" type="text" maxlength="500" [(ngModel)]="formEdicion.direccion.nombreVia" placeholder="Nombre de la vía" />
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Número</label>
                    <input class="edit-input" type="text" maxlength="50" [(ngModel)]="formEdicion.direccion.numeroVia" placeholder="Número" />
                  </div>
                  <div class="edit-field edit-field--full">
                    <label class="edit-label">Referencia</label>
                    <input class="edit-input" type="text" maxlength="500" [(ngModel)]="formEdicion.direccion.referencia" placeholder="Referencia adicional" />
                  </div>
                </div>

                <div class="edit-actions">
                  <button type="button" class="btn btn-outline" (click)="cancelarEdicion()" [disabled]="guardandoCambios()">
                    Cancelar
                  </button>
                  <button type="button" class="btn btn-primary" (click)="guardarCambios()" [disabled]="guardandoCambios()">
                    {{ guardandoCambios() ? 'Guardando...' : 'Guardar cambios' }}
                  </button>
                </div>
              </div>
            </div>
          }

          <div class="detail-card">
            <h2 class="detail-title">Auditoría</h2>
            <div class="detail-row">
              <span class="detail-label">Creado Por</span>
              <span class="detail-value">{{ empresa()!.usuarioCreacion || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Fecha Creación</span>
              <span class="detail-value">{{ empresa()!.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Modificado Por</span>
              <span class="detail-value">{{ empresa()!.usuarioModificacion || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Fecha Modificación</span>
              <span class="detail-value">{{ empresa()!.fechaModificacion | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>

        <div class="detail-card" style="margin-top: 2rem;">
          <div class="table-header">
            <h2 class="detail-title">Encuestas de la empresa</h2>
            <span class="table-count">
              {{ encuestasTotal() }} encuestas encontradas
            </span>
          </div>

          @if (encuestasError()) {
            <div class="alert alert-danger">
              {{ encuestasError() }}
            </div>
          }

          @if (encuestasCargando()) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Cargando encuestas...</p>
            </div>
          } @else {
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Tipo de Encuesta</th>
                    <th>Fecha de Encuesta</th>
                    <th>Fecha de Creación</th>
                    <th>Creado Por</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  @for (encuesta of encuestas(); track encuesta.encuestaId) {
                    <tr>
                      <td>{{ encuesta.tipoEncuestaValor || encuesta.tipoEncuesta }}</td>
                      <td>{{ encuesta.fechaEncuesta || '-' }}</td>
                      <td>{{ encuesta.fechaCreacion || '-' }}</td>
                      <td>{{ encuesta.usuarioCreacion || '-' }}</td>
                      <td>
                        <div class="estado-badge" [ngClass]="getEstadoClass(encuesta.estadoId)">
                          {{ encuesta.estado?.descripcionEstado || encuesta.estadoId }}
                        </div>
                      </td>
                      <td>
                        <div class="acciones-container">
                          @if (encuesta.estado?.descripcionEstado?.toLowerCase()?.includes('registro')) {
                            <button
                              class="btn-accion"
                              (click)="reanudarEncuesta(encuesta.encuestaId!)"
                              title="Reanudar encuesta">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14"></path>
                                <path d="m12 5 7 7-7 7"></path>
                              </svg>
                            </button>
                          }
                          @if (encuesta.estado?.descripcionEstado?.toLowerCase()?.includes('observ')) {
                            <button
                              class="btn-accion"
                              (click)="editarEncuesta(encuesta.encuestaId!)"
                              title="Editar encuesta">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                              </svg>
                            </button>
                          }
                          @if (encuesta.estado?.descripcionEstado && !(encuesta.estado?.descripcionEstado?.toLowerCase()?.includes('registro')) && !(encuesta.estado?.descripcionEstado?.toLowerCase()?.includes('observ'))) {
                            <button
                              class="btn-accion"
                              (click)="revisarEncuesta(encuesta.encuestaId!)"
                              title="Revisar encuesta">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                              </svg>
                            </button>
                          }
                          <button
                            class="btn-accion btn-clonar"
                            (click)="abrirDialogoClonar(encuesta)"
                            title="Clonar encuesta">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                              <circle cx="8.5" cy="7" r="4"></circle>
                              <path d="M20 8v6"></path>
                              <path d="M23 11h-6"></path>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="6" class="empty-message">No hay encuestas registradas para esta empresa</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            @if (encuestasTotalPaginas() > 1) {
              <div class="pagination">
                <button
                  [disabled]="encuestasPagina() === 1"
                  (click)="cambiarPaginaEncuestas(encuestasPagina() - 1)">
                  Anterior
                </button>
                <span>Página {{ encuestasPagina() }} de {{ encuestasTotalPaginas() }}</span>
                <button
                  [disabled]="encuestasPagina() === encuestasTotalPaginas()"
                  (click)="cambiarPaginaEncuestas(encuestasPagina() + 1)">
                  Siguiente
                </button>
              </div>
            }
          }
        </div>

        <div class="detail-card" style="margin-top: 2rem;">
          <div class="table-header">
            <h2 class="detail-title">Encuestados asociados</h2>
            <span class="table-count">{{ encuestados().length }} encuestado(s)</span>
          </div>

          @if (encuestadosCargando()) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Cargando encuestados...</p>
            </div>
          } @else if (encuestados().length === 0) {
            <div class="empty-state">
              <p>No hay encuestados registrados en las encuestas de esta empresa.</p>
            </div>
          } @else {
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Nombres</th>
                    <th>Apellido Paterno</th>
                    <th>Cargo</th>
                    <th>Medio de Contacto</th>
                    <th>Contacto</th>
                  </tr>
                </thead>
                <tbody>
                  @for (enc of encuestados(); track enc.encuestadoId) {
                    <tr>
                      <td>{{ enc.nombres }}</td>
                      <td>{{ enc.apepat || '-' }}</td>
                      <td>{{ enc.cargo || '-' }}</td>
                      <td>{{ enc.tipoContacto || '-' }}</td>
                      <td>{{ enc.contacto || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
    </div>
  </main>
</div>

<!-- Modal de confirmación de clonación -->
<app-confirm-dialog
  [isOpen]="mostrarModalClonar"
  title="Clonar Encuesta"
  message="¿Estás seguro de que deseas clonar esta encuesta? Se copiarán todos los datos incluyendo la información de la obra y marcas. La nueva encuesta tendrá estado 'En Registro'."
  confirmText="Clonar"
  cancelText="Cancelar"
  [isLoading]="clonandoEncuesta"
  (confirm)="confirmarClonar()"
  (cancel)="cerrarDialogoClonar()">
</app-confirm-dialog>
